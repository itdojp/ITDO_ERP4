// Draft Prisma schema for ERP4 MVP
// Provider: PostgreSQL (set DATABASE_URL in env)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum ProjectStatus {
  draft // 起案中
  active // 進行中
  on_hold // 保留
  closed // 完了
}

enum ProjectMemberRole {
  leader
  member
}

enum DocStatus {
  draft // 下書き/未送信
  pending_qa // 管理部レビュー待ち
  pending_exec // 経営承認待ち
  approved // 承認済み
  rejected // 却下
  sent // 送付済み
  paid // 支払/入金済み
  cancelled // 取り消し
  received // 受領済み（仕入/業者系）
  acknowledged // 確認済み
}

enum TimeStatus {
  submitted // 提出
  approved // 承認
  rejected // 差戻し
}

enum LeaveStatus {
  draft
  pending_manager
  approved
  rejected
}

enum FlowType {
  estimate // 見積
  invoice // 請求
  expense // 経費
  leave // 休暇
  time // 工数/残業
  purchase_order // 発注書
  vendor_invoice // 業者請求
  vendor_quote // 業者見積
}

enum AlertType {
  budget_overrun // 予算超過
  overtime // 残業超過
  approval_delay // 承認遅延
  approval_escalation // 承認期限エスカレーション
  delivery_due // 納期超過の未請求
  integration_failure // 外部連携失敗
  daily_report_missing // 日報未提出
}

enum TemplateKind {
  estimate // 見積
  invoice // 請求
  purchase_order // 発注書
}

enum IntegrationType {
  hr
  crm
}

enum IntegrationStatus {
  active
  disabled
}

enum IntegrationRunStatus {
  running
  success
  failed
}

model Customer {
  id                    String    @id @default(uuid())
  code                  String    @unique
  name                  String
  invoiceRegistrationId String?
  taxRegion             String?
  billingAddress        String?
  status                String
  externalSource        String?
  externalId            String?
  contacts              Contact[]
  projects              Project[]
  createdAt             DateTime  @default(now())
  createdBy             String?
  updatedAt             DateTime  @updatedAt
  updatedBy             String?
}

model Vendor {
  id             String          @id @default(uuid())
  code           String          @unique
  name           String
  bankInfo       String?
  taxRegion      String?
  status         String
  externalSource String?
  externalId     String?
  contacts       Contact[]
  purchaseOrders PurchaseOrder[]
  vendorQuotes   VendorQuote[]
  vendorInvoices VendorInvoice[]
  createdAt      DateTime        @default(now())
  createdBy      String?
  updatedAt      DateTime        @updatedAt
  updatedBy      String?
}

model Contact {
  id         String    @id @default(uuid())
  customer   Customer? @relation(fields: [customerId], references: [id])
  customerId String?
  vendor     Vendor?   @relation(fields: [vendorId], references: [id])
  vendorId   String?
  name       String
  email      String?
  phone      String?
  role       String?
  isPrimary  Boolean   @default(false)
  createdAt  DateTime  @default(now())
  createdBy  String?
  updatedAt  DateTime  @updatedAt
  updatedBy  String?
}

model Project {
  id                      String                    @id @default(uuid())
  code                    String                    @unique
  name                    String
  status                  ProjectStatus             @default(draft)
  projectType             String?
  parent                  Project?                  @relation("ProjectToProject", fields: [parentId], references: [id], onDelete: Restrict)
  parentId                String?
  children                Project[]                 @relation("ProjectToProject")
  customer                Customer?                 @relation(fields: [customerId], references: [id], onDelete: Restrict)
  customerId              String?
  ownerUserId             String?
  orgUnitId               String?
  startDate               DateTime?
  endDate                 DateTime?
  currency                String?
  planHours               Decimal?
  budgetCost              Decimal?
  recurringTemplate       RecurringProjectTemplate?
  recurringGenerationLogs RecurringGenerationLog[]
  members                 ProjectMember[]
  tasks                   ProjectTask[]
  baselines               ProjectBaseline[]
  milestones              ProjectMilestone[]
  notifications           AppNotification[]
  chatRooms               ChatRoom[]
  estimates               Estimate[]
  invoices                Invoice[]
  timeEntries             TimeEntry[]
  expenses                Expense[]
  purchaseOrders          PurchaseOrder[]
  vendorQuotes            VendorQuote[]
  vendorInvoices          VendorInvoice[]
  rateCards               RateCard[]
  approvalInstances       ApprovalInstance[]
  periodLocks             PeriodLock[]
  createdAt               DateTime                  @default(now())
  createdBy               String?
  updatedAt               DateTime                  @updatedAt
  updatedBy               String?
  deletedAt               DateTime?
  deletedReason           String?
  ChatBreakGlassRequest   ChatBreakGlassRequest[]
  ProjectTaskDependency   ProjectTaskDependency[]

  @@index([status, deletedAt])
  @@index([customerId, deletedAt])
  @@index([ownerUserId, deletedAt])
}

model ProjectMember {
  id        String            @id @default(uuid())
  project   Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String
  userId    String
  role      ProjectMemberRole @default(member)
  createdAt DateTime          @default(now())
  createdBy String?
  updatedAt DateTime          @updatedAt
  updatedBy String?

  @@unique([projectId, userId])
  @@index([userId])
  @@index([projectId])
}

model ProjectTask {
  id                  String                  @id @default(uuid())
  project             Project                 @relation(fields: [projectId], references: [id], onDelete: Restrict)
  projectId           String
  parentTask          ProjectTask?            @relation("TaskToTask", fields: [parentTaskId], references: [id], onDelete: Restrict)
  parentTaskId        String?
  children            ProjectTask[]           @relation("TaskToTask")
  name                String
  wbsCode             String?
  assigneeId          String?
  status              String?
  progressPercent     Int?
  planStart           DateTime?
  planEnd             DateTime?
  actualStart         DateTime?
  actualEnd           DateTime?
  baselineId          String?
  dependsOn           ProjectTaskDependency[] @relation("TaskDependencyTo")
  requiredFor         ProjectTaskDependency[] @relation("TaskDependencyFrom")
  timeEntries         TimeEntry[]
  createdAt           DateTime                @default(now())
  createdBy           String?
  updatedAt           DateTime                @updatedAt
  updatedBy           String?
  deletedAt           DateTime?
  deletedReason       String?
  ProjectBaselineTask ProjectBaselineTask[]

  @@index([projectId, deletedAt])
  @@index([parentTaskId, deletedAt])
}

model ProjectTaskDependency {
  id         String      @id @default(uuid())
  project    Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId  String
  fromTask   ProjectTask @relation("TaskDependencyFrom", fields: [fromTaskId], references: [id], onDelete: Cascade)
  fromTaskId String
  toTask     ProjectTask @relation("TaskDependencyTo", fields: [toTaskId], references: [id], onDelete: Cascade)
  toTaskId   String
  createdAt  DateTime    @default(now())
  createdBy  String?

  @@unique([fromTaskId, toTaskId])
  @@index([projectId, createdAt])
  @@index([fromTaskId])
  @@index([toTaskId])
}

model ProjectBaseline {
  id            String                @id @default(uuid())
  project       Project               @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId     String
  name          String
  currency      String?
  planHours     Decimal?
  budgetCost    Decimal?
  tasks         ProjectBaselineTask[]
  createdAt     DateTime              @default(now())
  createdBy     String?
  deletedAt     DateTime?
  deletedReason String?

  @@index([projectId, createdAt])
  @@index([projectId, deletedAt])
}

model ProjectBaselineTask {
  id              String          @id @default(uuid())
  baseline        ProjectBaseline @relation(fields: [baselineId], references: [id], onDelete: Cascade)
  baselineId      String
  task            ProjectTask     @relation(fields: [taskId], references: [id], onDelete: Restrict)
  taskId          String
  name            String
  status          String?
  planStart       DateTime?
  planEnd         DateTime?
  progressPercent Int?
  createdAt       DateTime        @default(now())
  createdBy       String?

  @@unique([baselineId, taskId])
  @@index([baselineId])
  @@index([taskId])
}

model AppNotification {
  id         String                    @id @default(uuid())
  userId     String
  kind       String
  project    Project?                  @relation(fields: [projectId], references: [id], onDelete: SetNull)
  projectId  String?
  messageId  String?
  payload    Json?
  readAt     DateTime?
  deliveries AppNotificationDelivery[]
  createdAt  DateTime                  @default(now())
  createdBy  String?
  updatedAt  DateTime                  @updatedAt
  updatedBy  String?

  @@index([userId, createdAt])
  @@index([userId, readAt, createdAt])
  @@index([projectId])
  @@index([kind, createdAt])
  @@index([kind, messageId, userId])
}

model AppNotificationDelivery {
  id                String          @id @default(uuid())
  notification      AppNotification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  notificationId    String
  channel           String
  status            String
  target            String?
  payload           Json?
  providerMessageId String?
  error             String?
  retryCount        Int             @default(0)
  nextRetryAt       DateTime?
  lastErrorAt       DateTime?
  sentAt            DateTime?
  createdAt         DateTime        @default(now())
  createdBy         String?

  @@unique([notificationId, channel])
  @@index([status, nextRetryAt])
  @@index([channel, sentAt])
  @@index([notificationId, createdAt])
}

model UserNotificationPreference {
  /// NOTE: userId intentionally has no FK to support JWT/external users (consistent with AppNotification).
  userId                     String   @id
  emailMode                  String   @default("digest")
  emailDigestIntervalMinutes Int      @default(10)
  muteAllUntil               DateTime?
  createdAt                  DateTime @default(now())
  createdBy                  String?
  updatedAt                  DateTime @updatedAt
  updatedBy                  String?
}

model ChatRoomNotificationSetting {
  id               String   @id @default(uuid())
  room             ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  roomId           String
  /// NOTE: userId intentionally has no FK to support JWT/external users (consistent with AppNotification).
  userId           String
  notifyAllPosts   Boolean  @default(true)
  notifyMentions   Boolean  @default(true)
  muteUntil        DateTime?
  createdAt        DateTime @default(now())
  createdBy        String?
  updatedAt        DateTime @updatedAt
  updatedBy        String?

  @@unique([roomId, userId])
  @@index([userId])
  @@index([roomId])
}

model ChatRoom {
  id                        String           @id @default(uuid())
  type                      String // project/department/company/private_group/dm
  name                      String
  isOfficial                Boolean          @default(true)
  project                   Project?         @relation(fields: [projectId], references: [id], onDelete: Restrict)
  projectId                 String?
  groupId                   String?
  viewerGroupIds            Json?
  posterGroupIds            Json?
  allowExternalUsers        Boolean          @default(false)
  allowExternalIntegrations Boolean          @default(false)
  createdAt                 DateTime         @default(now())
  createdBy                 String?
  updatedAt                 DateTime         @updatedAt
  updatedBy                 String?
  deletedAt                 DateTime?
  deletedReason             String?
  members                   ChatRoomMember[]
  messages                  ChatMessage[]
  ackRequests               ChatAckRequest[]
  readStates                ChatReadState[]
  notificationSettings      ChatRoomNotificationSetting[]

  @@unique([type, projectId])
  @@index([type, createdAt])
  @@index([projectId, createdAt])
  @@index([deletedAt])
}

model ChatRoomMember {
  id            String    @id @default(uuid())
  room          ChatRoom  @relation(fields: [roomId], references: [id], onDelete: Cascade)
  roomId        String
  userId        String
  role          String    @default("member")
  createdAt     DateTime  @default(now())
  createdBy     String?
  updatedAt     DateTime  @updatedAt
  updatedBy     String?
  deletedAt     DateTime?
  deletedReason String?

  @@unique([roomId, userId])
  @@index([userId])
  @@index([roomId])
}

model ChatMessage {
  id            String           @id @default(uuid())
  room          ChatRoom         @relation(fields: [roomId], references: [id], onDelete: Restrict)
  roomId        String
  userId        String
  body          String
  tags          Json?
  reactions     Json?
  mentions      Json?
  mentionsAll   Boolean          @default(false)
  ackRequest    ChatAckRequest?
  ackLinks      ChatAckLink[]
  attachments   ChatAttachment[]
  createdAt     DateTime         @default(now())
  createdBy     String?
  updatedAt     DateTime         @updatedAt
  updatedBy     String?
  deletedAt     DateTime?
  deletedReason String?

  @@index([roomId, createdAt])
  @@index([roomId, userId, mentionsAll, createdAt])
  @@index([deletedAt, createdAt])
}

model ChatAckRequest {
  id              String      @id @default(uuid())
  message         ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId       String      @unique
  room            ChatRoom    @relation(fields: [roomId], references: [id], onDelete: Restrict)
  roomId          String
  requiredUserIds Json
  requestedUserIds Json?
  requestedGroupIds Json?
  requestedRoles  Json?
  dueAt           DateTime?
  remindIntervalHours Int?
  escalationAfterHours Int?
  escalationUserIds Json?
  escalationGroupIds Json?
  escalationRoles Json?
  template       ChatAckTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  templateId     String?
  canceledAt      DateTime?
  canceledBy      String?
  createdAt       DateTime    @default(now())
  createdBy       String?
  acks            ChatAck[]
  links           ChatAckLink[]

  @@index([roomId, createdAt])
}

model ChatAckTemplate {
  id                   String   @id @default(uuid())
  flowType             FlowType
  actionKey            String
  messageBody          String
  requiredUserIds      Json?
  requiredGroupIds     Json?
  requiredRoles        Json?
  dueInHours           Int?
  remindIntervalHours  Int?
  escalationAfterHours Int?
  escalationUserIds    Json?
  escalationGroupIds   Json?
  escalationRoles      Json?
  isEnabled            Boolean  @default(true)
  createdAt            DateTime @default(now())
  createdBy            String?
  updatedAt            DateTime @updatedAt
  updatedBy            String?
  links                ChatAckLink[]
  ackRequests          ChatAckRequest[]

  @@index([flowType, actionKey, isEnabled])
}

model ChatAckLink {
  id           String         @id @default(uuid())
  ackRequest   ChatAckRequest @relation(fields: [ackRequestId], references: [id], onDelete: Cascade)
  ackRequestId String
  message      ChatMessage    @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId    String
  template     ChatAckTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  templateId   String?
  targetTable  String
  targetId     String
  flowType     String?
  actionKey    String?
  createdAt    DateTime       @default(now())
  createdBy    String?
  updatedAt    DateTime       @updatedAt
  updatedBy    String?

  @@unique([ackRequestId, targetTable, targetId])
  @@index([targetTable, targetId])
  @@index([ackRequestId])
  @@index([messageId])
}

model ChatAck {
  id        String         @id @default(uuid())
  request   ChatAckRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  requestId String
  userId    String
  ackedAt   DateTime       @default(now())

  @@unique([requestId, userId])
  @@index([userId])
}

model ChatAttachment {
  id            String      @id @default(uuid())
  message       ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId     String
  provider      String
  providerKey   String
  sha256        String?
  sizeBytes     Int?
  mimeType      String?
  originalName  String
  createdAt     DateTime    @default(now())
  createdBy     String?
  deletedAt     DateTime?
  deletedReason String?

  @@unique([provider, providerKey])
  @@index([messageId])
  @@index([createdAt])
}

model ChatReadState {
  id         String   @id @default(uuid())
  room       ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  roomId     String
  userId     String
  lastReadAt DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([roomId, userId])
  @@index([userId])
  @@index([roomId])
}

model ChatBreakGlassRequest {
  id              String                    @id @default(uuid())
  targetType      String // project/room
  project         Project?                  @relation(fields: [projectId], references: [id], onDelete: SetNull)
  projectId       String?
  roomId          String?
  requesterUserId String
  viewerUserId    String
  reasonCode      String
  reasonText      String
  targetFrom      DateTime?
  targetUntil     DateTime?
  ttlHours        Int                       @default(24)
  status          String                    @default("requested")
  approved1By     String?
  approved1Role   String?
  approved1At     DateTime?
  approved2By     String?
  approved2Role   String?
  approved2At     DateTime?
  rejectedBy      String?
  rejectedRole    String?
  rejectedAt      DateTime?
  rejectedReason  String?
  grantedAt       DateTime?
  expiresAt       DateTime?
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt
  accessLogs      ChatBreakGlassAccessLog[]

  @@index([status, createdAt])
  @@index([projectId, createdAt])
  @@index([viewerUserId, createdAt])
}

model ChatBreakGlassAccessLog {
  id          String                @id @default(uuid())
  request     ChatBreakGlassRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  requestId   String
  actorUserId String
  action      String
  metadata    Json?
  accessedAt  DateTime              @default(now())

  @@index([requestId, accessedAt])
  @@index([actorUserId, accessedAt])
}

model ChatSetting {
  id                            String   @id @default("default")
  allowUserPrivateGroupCreation Boolean  @default(true)
  allowDmCreation               Boolean  @default(true)
  ackMaxRequiredUsers           Int      @default(50)
  ackMaxRequiredGroups          Int      @default(20)
  ackMaxRequiredRoles           Int      @default(20)
  createdAt                     DateTime @default(now())
  createdBy                     String?
  updatedAt                     DateTime @updatedAt
  updatedBy                     String?
}

model WorklogSetting {
  id           String   @id @default("default")
  editableDays Int      @default(14)
  createdAt    DateTime @default(now())
  createdBy    String?
  updatedAt    DateTime @updatedAt
  updatedBy    String?
}

model AnnotationSetting {
  id                       String   @id @default("default")
  maxExternalUrlCount      Int      @default(20)
  maxExternalUrlLength     Int      @default(2048)
  maxExternalUrlTotalLength Int     @default(16384)
  maxNotesLength           Int      @default(20000)
  createdAt                DateTime @default(now())
  createdBy                String?
  updatedAt                DateTime @updatedAt
  updatedBy                String?
}

model Annotation {
  id          String   @id @default(uuid())
  targetKind  String
  targetId    String
  notes       String?
  externalUrls Json?
  internalRefs Json?
  createdAt   DateTime @default(now())
  createdBy   String?
  updatedAt   DateTime @updatedAt
  updatedBy   String?

  @@unique([targetKind, targetId])
}

model AnnotationLog {
  id          String   @id @default(uuid())
  targetKind  String
  targetId    String
  notes       String?
  externalUrls Json?
  internalRefs Json?
  reasonCode  String?
  reasonText  String?
  actorRole   String?
  createdAt   DateTime @default(now())
  createdBy   String?

  @@index([createdAt])
  @@index([targetKind, targetId, createdAt(sort: Desc)])
}

model ProjectMilestone {
  id                String    @id @default(uuid())
  project           Project   @relation(fields: [projectId], references: [id], onDelete: Restrict)
  projectId         String
  name              String
  amount            Decimal
  billUpon          String // enum候補: date/acceptance/time
  dueDate           DateTime?
  taxRate           Decimal?
  invoiceTemplateId String?
  invoices          Invoice[]
  createdAt         DateTime  @default(now())
  createdBy         String?
  updatedAt         DateTime  @updatedAt
  updatedBy         String?
  deletedAt         DateTime?
  deletedReason     String?

  @@index([projectId, deletedAt])
  @@index([deletedAt, dueDate])
}

model RecurringProjectTemplate {
  id                     String                   @id @default(uuid())
  project                Project                  @relation(fields: [projectId], references: [id], onDelete: Restrict)
  projectId              String                   @unique
  logs                   RecurringGenerationLog[]
  frequency              String // monthly/quarterly/semiannual/annual
  defaultAmount          Decimal?
  defaultCurrency        String?
  defaultTaxRate         Decimal?
  defaultTerms           String?
  defaultMilestoneName   String?
  billUpon               String?
  dueDateRule            Json?
  shouldGenerateEstimate Boolean                  @default(false)
  shouldGenerateInvoice  Boolean                  @default(true)
  nextRunAt              DateTime?
  timezone               String?
  isActive               Boolean                  @default(true)
  createdAt              DateTime                 @default(now())
  createdBy              String?
  updatedAt              DateTime                 @updatedAt
  updatedBy              String?
}

model RecurringGenerationLog {
  id          String                   @id @default(uuid())
  template    RecurringProjectTemplate @relation(fields: [templateId], references: [id], onDelete: Restrict)
  templateId  String
  project     Project                  @relation(fields: [projectId], references: [id], onDelete: Restrict)
  projectId   String
  periodKey   String
  runAt       DateTime
  status      String
  message     String?
  estimateId  String?
  invoiceId   String?
  milestoneId String?
  createdAt   DateTime                 @default(now())
  createdBy   String?

  @@unique([templateId, periodKey])
  @@index([projectId, periodKey])
}

model Estimate {
  id              String         @id @default(uuid())
  project         Project        @relation(fields: [projectId], references: [id], onDelete: Restrict)
  projectId       String
  estimateNo      String         @unique
  version         Int
  totalAmount     Decimal
  currency        String
  status          DocStatus      @default(draft)
  validUntil      DateTime?
  notes           String?
  pdfUrl          String?
  emailMessageId  String?
  numberingSerial Int?
  lines           EstimateLine[]
  invoices        Invoice[]
  createdAt       DateTime       @default(now())
  createdBy       String?
  updatedAt       DateTime       @updatedAt
  updatedBy       String?
  deletedAt       DateTime?
  deletedReason   String?

  @@index([projectId, status, deletedAt])
  @@index([createdAt])
}

model EstimateLine {
  id          String   @id @default(uuid())
  estimate    Estimate @relation(fields: [estimateId], references: [id])
  estimateId  String
  description String
  quantity    Decimal  @default(1)
  unitPrice   Decimal
  taxRate     Decimal?
  taskId      String?
}

model Invoice {
  id                String            @id @default(uuid())
  project           Project           @relation(fields: [projectId], references: [id], onDelete: Restrict)
  projectId         String
  estimate          Estimate?         @relation(fields: [estimateId], references: [id], onDelete: SetNull)
  estimateId        String? // 見積なし請求を許容
  milestone         ProjectMilestone? @relation(fields: [milestoneId], references: [id], onDelete: SetNull)
  milestoneId       String? // 任意。未紐付けは納品請求漏れチェック対象
  invoiceNo         String            @unique
  issueDate         DateTime?
  dueDate           DateTime?
  currency          String
  totalAmount       Decimal
  status            DocStatus         @default(draft)
  paidAt            DateTime?
  paidBy            String?
  pdfUrl            String?
  emailMessageId    String?
  numberingSerial   Int?
  lines             BillingLine[]
  billedTimeEntries TimeEntry[]       @relation("InvoiceToTimeEntries")
  createdAt         DateTime          @default(now())
  createdBy         String?
  updatedAt         DateTime          @updatedAt
  updatedBy         String?
  deletedAt         DateTime?
  deletedReason     String?

  @@index([projectId, status, deletedAt])
  @@index([issueDate])
  @@index([dueDate])
}

model BillingLine {
  id             String   @id @default(uuid())
  invoice        Invoice  @relation(fields: [invoiceId], references: [id])
  invoiceId      String
  description    String
  quantity       Decimal  @default(1)
  unitPrice      Decimal
  taxRate        Decimal?
  taskId         String?
  timeEntryRange String?
}

model PurchaseOrder {
  id              String              @id @default(uuid())
  project         Project             @relation(fields: [projectId], references: [id], onDelete: Restrict)
  projectId       String
  vendor          Vendor              @relation(fields: [vendorId], references: [id], onDelete: Restrict)
  vendorId        String
  vendorInvoices  VendorInvoice[]
  poNo            String              @unique
  issueDate       DateTime?
  dueDate         DateTime?
  currency        String
  totalAmount     Decimal
  status          DocStatus           @default(draft)
  pdfUrl          String?
  numberingSerial Int?
  lines           PurchaseOrderLine[]
  createdAt       DateTime            @default(now())
  createdBy       String?
  updatedAt       DateTime            @updatedAt
  updatedBy       String?
  deletedAt       DateTime?
  deletedReason   String?

  @@index([projectId, status, deletedAt])
  @@index([vendorId, status, deletedAt])
  @@index([issueDate])
  @@index([dueDate])
}

model PurchaseOrderLine {
  id              String        @id @default(uuid())
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  purchaseOrderId String
  description     String
  quantity        Decimal       @default(1)
  unitPrice       Decimal
  taxRate         Decimal?
  taskId          String?
  expenseId       String?
}

model VendorQuote {
  id            String    @id @default(uuid())
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Restrict)
  projectId     String
  vendor        Vendor    @relation(fields: [vendorId], references: [id], onDelete: Restrict)
  vendorId      String
  quoteNo       String?
  issueDate     DateTime?
  currency      String
  totalAmount   Decimal
  status        DocStatus @default(received)
  documentUrl   String?
  createdAt     DateTime  @default(now())
  createdBy     String?
  updatedAt     DateTime  @updatedAt
  updatedBy     String?
  deletedAt     DateTime?
  deletedReason String?

  @@index([projectId, status, deletedAt])
  @@index([vendorId, status, deletedAt])
  @@index([issueDate])
}

model VendorInvoice {
  id              String    @id @default(uuid())
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Restrict)
  projectId       String
  vendor          Vendor    @relation(fields: [vendorId], references: [id], onDelete: Restrict)
  vendorId        String
  purchaseOrder   PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id], onDelete: SetNull)
  purchaseOrderId String?
  vendorInvoiceNo String?
  receivedDate    DateTime?
  dueDate         DateTime?
  currency        String
  totalAmount     Decimal
  status          DocStatus @default(received)
  documentUrl     String?
  numberingSerial Int?
  createdAt       DateTime  @default(now())
  createdBy       String?
  updatedAt       DateTime  @updatedAt
  updatedBy       String?
  deletedAt       DateTime?
  deletedReason   String?

  @@index([projectId, status, deletedAt])
  @@index([vendorId, status, deletedAt])
  @@index([purchaseOrderId])
  @@index([receivedDate])
  @@index([dueDate])
}

model TimeEntry {
  id              String       @id @default(uuid())
  project         Project      @relation(fields: [projectId], references: [id], onDelete: Restrict)
  projectId       String
  task            ProjectTask? @relation(fields: [taskId], references: [id], onDelete: SetNull)
  taskId          String?
  billedInvoice   Invoice?     @relation("InvoiceToTimeEntries", fields: [billedInvoiceId], references: [id], onDelete: SetNull)
  billedInvoiceId String?
  billedAt        DateTime?
  userId          String
  workDate        DateTime
  minutes         Int
  workType        String?
  location        String?
  notes           String?
  status          TimeStatus   @default(submitted)
  approvedBy      String?
  approvedAt      DateTime?
  createdAt       DateTime     @default(now())
  createdBy       String?
  updatedAt       DateTime     @updatedAt
  updatedBy       String?
  deletedAt       DateTime?
  deletedReason   String?

  @@index([projectId, workDate, deletedAt])
  @@index([userId, workDate])
  @@index([status])
  @@index([billedInvoiceId])
}

model RateCard {
  id        String    @id @default(uuid())
  project   Project?  @relation(fields: [projectId], references: [id])
  projectId String?
  role      String
  workType  String?
  unitPrice Decimal
  validFrom DateTime
  validTo   DateTime?
  currency  String

  @@index([projectId, workType, validFrom])
}

model Expense {
  id            String    @id @default(uuid())
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Restrict)
  projectId     String
  userId        String
  category      String
  amount        Decimal
  currency      String
  incurredOn    DateTime
  isShared      Boolean   @default(false)
  status        DocStatus @default(draft)
  receiptUrl    String?
  createdAt     DateTime  @default(now())
  createdBy     String?
  updatedAt     DateTime  @updatedAt
  updatedBy     String?
  deletedAt     DateTime?
  deletedReason String?

  @@index([projectId, deletedAt])
  @@index([userId, incurredOn])
  @@index([status])
}

model LeaveRequest {
  id        String      @id @default(uuid())
  userId    String
  leaveType String
  startDate DateTime
  endDate   DateTime
  hours     Int?
  status    LeaveStatus @default(draft)
  notes     String?
  createdAt DateTime    @default(now())
  createdBy String?
  updatedAt DateTime    @updatedAt
  updatedBy String?

  @@index([userId, startDate])
  @@index([status])
}

model ApprovalRule {
  id            String             @id @default(uuid())
  flowType      FlowType
  conditions    Json // amountMin/amountMax/isRecurring/skipUnder/projectType/customerId/orgUnitId/flowFlags
  steps         Json // [{stepOrder, approverGroupId?, approverUserId?, parallelKey?}]
  // Versioning/activation fields for rule selection.
  version       Int                @default(1)
  isActive      Boolean            @default(true)
  effectiveFrom DateTime           @default(now())
  instances     ApprovalInstance[]
  createdAt     DateTime           @default(now())
  createdBy     String?
  updatedAt     DateTime           @updatedAt
  updatedBy     String?

  @@index([flowType])
  @@index([flowType, isActive, effectiveFrom])
}

model ApprovalInstance {
  id          String         @id @default(uuid())
  flowType    FlowType
  targetTable String
  targetId    String
  project     Project?       @relation(fields: [projectId], references: [id], onDelete: SetNull)
  projectId   String?
  status      DocStatus      @default(pending_qa)
  currentStep Int?
  // Snapshot of stage-level completion rules per stepOrder (e.g. all/any/quorum).
  // Keep this on the instance to avoid changing semantics mid-flight when rules are edited.
  stagePolicy Json?
  rule        ApprovalRule   @relation(fields: [ruleId], references: [id])
  ruleId      String
  steps       ApprovalStep[]
  createdAt   DateTime       @default(now())
  createdBy   String?
  updatedAt   DateTime       @updatedAt
  updatedBy   String?

  @@index([projectId])
  @@index([status, createdAt])
  @@index([status, projectId])
}

model ApprovalStep {
  id              String           @id @default(uuid())
  instance        ApprovalInstance @relation(fields: [instanceId], references: [id])
  instanceId      String
  stepOrder       Int
  approverGroupId String?
  approverUserId  String?
  status          DocStatus        @default(pending_qa)
  actedBy         String?
  actedAt         DateTime?
  createdAt       DateTime         @default(now())
  createdBy       String?
  updatedAt       DateTime         @updatedAt
  updatedBy       String?

  @@index([instanceId])
  @@index([status])
  @@index([approverGroupId])
  @@index([approverUserId])
  @@index([status, approverGroupId])
  @@index([status, approverUserId])
}

model ActionPolicy {
  id               String   @id @default(uuid())
  flowType          FlowType
  actionKey         String
  priority          Int      @default(0)
  isEnabled         Boolean  @default(true)
  subjects          Json?
  stateConstraints  Json?
  requireReason     Boolean  @default(false)
  guards            Json?
  createdAt         DateTime @default(now())
  createdBy         String?
  updatedAt         DateTime @updatedAt
  updatedBy         String?

  @@index([flowType, actionKey])
  @@index([flowType, actionKey, isEnabled])
  @@index([isEnabled])
}

model AlertSetting {
  id               String    @id @default(uuid())
  type             AlertType
  threshold        Decimal
  period           String // day/week/month
  scopeProjectId   String?
  recipients       Json // emails/roles/users
  channels         Json // email/dashboard/ext_future
  remindAfterHours Int?
  remindMaxCount   Int?      @default(3)
  isEnabled        Boolean   @default(true)
  alerts           Alert[]
  createdAt        DateTime  @default(now())
  createdBy        String?
  updatedAt        DateTime  @updatedAt
  updatedBy        String?

  @@index([type, isEnabled])
}

model Alert {
  id            String       @id @default(uuid())
  setting       AlertSetting @relation(fields: [settingId], references: [id])
  settingId     String
  targetRef     String
  triggeredAt   DateTime     @default(now())
  reminderAt    DateTime?
  reminderCount Int          @default(0)
  status        String       @default("open")
  sentChannels  Json?
  sentResult    Json?
  createdAt     DateTime     @default(now())
  createdBy     String?
  updatedAt     DateTime     @updatedAt
  updatedBy     String?

  @@index([settingId])
  @@index([status, triggeredAt])
  @@index([targetRef, status])
}

model PushSubscription {
  id             String    @id @default(uuid())
  userId         String
  endpoint       String    @unique
  p256dh         String
  auth           String
  expirationTime DateTime?
  userAgent      String?
  topics         Json?
  consentAt      DateTime?
  isActive       Boolean   @default(true)
  lastSeenAt     DateTime?
  createdAt      DateTime  @default(now())
  createdBy      String?
  updatedAt      DateTime  @updatedAt
  updatedBy      String?

  @@index([userId, isActive])
}

model DocTemplateSetting {
  id            String       @id @default(uuid())
  kind          TemplateKind
  templateId    String
  numberRule    String
  layoutConfig  Json?
  logoUrl       String?
  signatureText String?
  isDefault     Boolean      @default(false)
  createdAt     DateTime     @default(now())
  createdBy     String?
  updatedAt     DateTime     @updatedAt
  updatedBy     String?

  @@index([kind])
}

model IntegrationSetting {
  id            String                @id @default(uuid())
  type          IntegrationType
  name          String?
  provider      String?
  status        IntegrationStatus     @default(active)
  schedule      String?
  config        Json?
  lastRunAt     DateTime?
  lastRunStatus IntegrationRunStatus?
  createdAt     DateTime              @default(now())
  createdBy     String?
  updatedAt     DateTime              @updatedAt
  updatedBy     String?
  runs          IntegrationRun[]

  @@index([type, status])
}

model IntegrationRun {
  id          String               @id @default(uuid())
  setting     IntegrationSetting   @relation(fields: [settingId], references: [id], onDelete: Cascade)
  settingId   String
  status      IntegrationRunStatus @default(running)
  startedAt   DateTime             @default(now())
  finishedAt  DateTime?
  message     String?
  metrics     Json?
  retryCount  Int                  @default(0)
  nextRetryAt DateTime?
  createdAt   DateTime             @default(now())
  createdBy   String?

  @@index([settingId, startedAt])
  @@index([status, startedAt])
}

model DocumentSendLog {
  id                String              @id @default(uuid())
  kind              TemplateKind
  targetTable       String
  targetId          String
  channel           String
  status            String
  recipients        Json?
  templateId        String?
  pdfUrl            String?
  providerMessageId String?
  error             String?
  metadata          Json?
  createdAt         DateTime            @default(now())
  createdBy         String?
  updatedAt         DateTime            @updatedAt
  updatedBy         String?
  DocumentSendEvent DocumentSendEvent[]

  @@index([targetTable, targetId])
  @@index([createdAt])
  @@index([targetTable, targetId, createdAt])
}

model DocumentSendEvent {
  id        String          @id @default(uuid())
  sendLog   DocumentSendLog @relation(fields: [sendLogId], references: [id], onDelete: Cascade)
  sendLogId String
  provider  String
  eventType String
  eventAt   DateTime?
  payload   Json?
  createdAt DateTime        @default(now())

  @@index([sendLogId])
  @@index([provider, eventType])
  @@index([createdAt])
}

model ReportSubscription {
  id            String           @id @default(uuid())
  name          String?
  reportKey     String
  format        String           @default("csv")
  schedule      String?
  params        Json?
  recipients    Json?
  channels      Json?
  isEnabled     Boolean          @default(true)
  lastRunAt     DateTime?
  lastRunStatus String?
  createdAt     DateTime         @default(now())
  createdBy     String?
  updatedAt     DateTime         @updatedAt
  updatedBy     String?
  deliveries    ReportDelivery[]

  @@index([reportKey, isEnabled])
  @@index([isEnabled, lastRunAt])
}

model ReportDelivery {
  id             String              @id @default(uuid())
  subscription   ReportSubscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  subscriptionId String?
  channel        String
  status         String
  target         String?
  payload        Json?
  error          String?
  retryCount     Int                 @default(0)
  nextRetryAt    DateTime?
  lastErrorAt    DateTime?
  sentAt         DateTime?
  createdAt      DateTime            @default(now())
  createdBy      String?

  @@index([subscriptionId, sentAt])
  @@index([status, sentAt])
  @@index([status, nextRetryAt])
}

model DailyReport {
  id               String   @id @default(uuid())
  userId           String
  reportDate       DateTime @db.Date
  content          String
  linkedProjectIds Json?
  status           String?
  revisions        DailyReportRevision[]
  createdAt        DateTime @default(now())
  createdBy        String?
  updatedAt        DateTime @updatedAt
  updatedBy        String?

  @@unique([userId, reportDate])
}

model DailyReportRevision {
  id            String   @id @default(uuid())
  dailyReport   DailyReport @relation(fields: [dailyReportId], references: [id], onDelete: Cascade)
  dailyReportId String
  version       Int
  content       String
  linkedProjectIds Json?
  status        String?
  reasonText    String?
  createdAt     DateTime @default(now())
  createdBy     String?

  @@unique([dailyReportId, version])
  @@index([dailyReportId, createdAt])
}

model WellbeingEntry {
  id                String   @id @default(uuid())
  userId            String
  entryDate         DateTime
  status            String // good/not_good
  helpRequested     Boolean  @default(false)
  notes             String?
  visibilityGroupId String
  createdAt         DateTime @default(now())
  createdBy         String?
  updatedAt         DateTime @updatedAt
  updatedBy         String?

  @@unique([userId, entryDate])
  @@index([visibilityGroupId, entryDate])
}

model NumberSequence {
  id            String   @id @default(uuid())
  kind          String // estimate/invoice/delivery/purchase_order/vendor_quote/vendor_invoice
  year          Int
  month         Int
  currentSerial Int
  version       Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([kind, year, month])
}

model AuditLog {
  id           String   @id @default(uuid())
  action       String
  userId       String?
  actorRole    String?
  actorGroupId String?
  requestId    String?
  ipAddress    String?
  userAgent    String?
  source       String?
  reasonCode   String?
  reasonText   String?
  targetTable  String?
  targetId     String?
  metadata     Json?
  createdAt    DateTime @default(now())

  @@index([targetTable, targetId])
  @@index([action])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([action, createdAt])
}

model ReassignmentLog {
  id            String   @id @default(uuid())
  targetTable   String
  targetId      String
  fromProjectId String?
  toProjectId   String?
  fromTaskId    String?
  toTaskId      String?
  reasonCode    String
  reasonText    String
  createdAt     DateTime @default(now())
  createdBy     String?

  @@index([targetTable, targetId])
  @@index([fromProjectId])
  @@index([toProjectId])
}

model PeriodLock {
  id        String   @id @default(uuid())
  period    String
  scope     String // global/project
  project   Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String?
  reason    String?
  closedAt  DateTime @default(now())
  closedBy  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([period, scope, projectId])
  @@index([scope, period])
  @@index([projectId])
}

model UserAccount {
  id            String      @id @default(uuid())
  externalId    String?     @unique
  userName      String      @unique
  displayName   String?
  givenName     String?
  familyName    String?
  active        Boolean     @default(true)
  emails        Json?
  phoneNumbers  Json?
  department    String?
  organization  String?
  managerUserId String?
  scimMeta      Json?
  createdAt     DateTime    @default(now())
  createdBy     String?
  updatedAt     DateTime    @updatedAt
  updatedBy     String?
  deletedAt     DateTime?
  deletedReason String?
  memberships   UserGroup[]

  @@index([active])
}

model UserGroup {
  id        String       @id @default(uuid())
  user      UserAccount  @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  group     GroupAccount @relation(fields: [groupId], references: [id], onDelete: Cascade)
  groupId   String
  createdAt DateTime     @default(now())

  @@unique([userId, groupId])
  @@index([groupId])
  @@index([userId])
}

model GroupAccount {
  id          String      @id @default(uuid())
  externalId  String?     @unique
  displayName String
  scimMeta    Json?
  active      Boolean     @default(true)
  createdAt   DateTime    @default(now())
  createdBy   String?
  updatedAt   DateTime    @updatedAt
  updatedBy   String?
  memberships UserGroup[]

  @@index([displayName])
}
