// Draft Prisma schema for ERP4 MVP
// Provider: PostgreSQL (set DATABASE_URL in env)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ProjectStatus {
  draft // 起案中
  active // 進行中
  on_hold // 保留
  closed // 完了
}

enum DocStatus {
  draft // 下書き/未送信
  pending_qa // 管理部レビュー待ち
  pending_exec // 経営承認待ち
  approved // 承認済み
  rejected // 却下
  sent // 送付済み
  paid // 支払/入金済み
  cancelled // 取り消し
  received // 受領済み（仕入/業者系）
  acknowledged // 確認済み
}

enum TimeStatus {
  submitted // 提出
  approved // 承認
  rejected // 差戻し
}

enum LeaveStatus {
  draft
  pending_manager
  approved
  rejected
}

enum FlowType {
  estimate // 見積
  invoice // 請求
  expense // 経費
  leave // 休暇
  time // 工数/残業
  purchase_order // 発注書
  vendor_invoice // 業者請求
  vendor_quote // 業者見積
}

enum AlertType {
  budget_overrun // 予算超過
  overtime // 残業超過
  approval_delay // 承認遅延
  approval_escalation // 承認期限エスカレーション
  delivery_due // 納期超過の未請求
}

enum TemplateKind {
  estimate // 見積
  invoice // 請求
  purchase_order // 発注書
}

model Customer {
  id                    String    @id @default(uuid())
  code                  String    @unique
  name                  String
  invoiceRegistrationId String?
  taxRegion             String?
  billingAddress        String?
  status                String
  externalSource        String?
  externalId            String?
  contacts              Contact[]
  projects              Project[]
  createdAt             DateTime  @default(now())
  createdBy             String?
  updatedAt             DateTime  @updatedAt
  updatedBy             String?
}

model Vendor {
  id             String          @id @default(uuid())
  code           String          @unique
  name           String
  bankInfo       String?
  taxRegion      String?
  status         String
  externalSource String?
  externalId     String?
  contacts       Contact[]
  purchaseOrders PurchaseOrder[]
  vendorQuotes   VendorQuote[]
  vendorInvoices VendorInvoice[]
  createdAt      DateTime        @default(now())
  createdBy      String?
  updatedAt      DateTime        @updatedAt
  updatedBy      String?
}

model Contact {
  id         String    @id @default(uuid())
  customer   Customer? @relation(fields: [customerId], references: [id])
  customerId String?
  vendor     Vendor?   @relation(fields: [vendorId], references: [id])
  vendorId   String?
  name       String
  email      String?
  phone      String?
  role       String?
  isPrimary  Boolean   @default(false)
  createdAt  DateTime  @default(now())
  createdBy  String?
  updatedAt  DateTime  @updatedAt
  updatedBy  String?
}

model Project {
  id                      String                    @id @default(uuid())
  code                    String                    @unique
  name                    String
  status                  ProjectStatus             @default(draft)
  projectType             String?
  parent                  Project?                  @relation("ProjectToProject", fields: [parentId], references: [id], onDelete: Restrict)
  parentId                String?
  children                Project[]                 @relation("ProjectToProject")
  customer                Customer?                 @relation(fields: [customerId], references: [id], onDelete: Restrict)
  customerId              String?
  ownerUserId             String?
  orgUnitId               String?
  startDate               DateTime?
  endDate                 DateTime?
  currency                String?
  recurringTemplate       RecurringProjectTemplate?
  recurringGenerationLogs RecurringGenerationLog[]
  tasks                   ProjectTask[]
  milestones              ProjectMilestone[]
  chatMessages            ProjectChatMessage[]
  estimates               Estimate[]
  invoices                Invoice[]
  timeEntries             TimeEntry[]
  expenses                Expense[]
  purchaseOrders          PurchaseOrder[]
  vendorQuotes            VendorQuote[]
  vendorInvoices          VendorInvoice[]
  rateCards               RateCard[]
  approvalInstances       ApprovalInstance[]
  createdAt               DateTime                  @default(now())
  createdBy               String?
  updatedAt               DateTime                  @updatedAt
  updatedBy               String?
  deletedAt               DateTime?
  deletedReason           String?

  @@index([status, deletedAt])
  @@index([customerId, deletedAt])
  @@index([ownerUserId, deletedAt])
}

model ProjectTask {
  id            String        @id @default(uuid())
  project       Project       @relation(fields: [projectId], references: [id], onDelete: Restrict)
  projectId     String
  parentTask    ProjectTask?  @relation("TaskToTask", fields: [parentTaskId], references: [id], onDelete: Restrict)
  parentTaskId  String?
  children      ProjectTask[] @relation("TaskToTask")
  name          String
  wbsCode       String?
  assigneeId    String?
  status        String?
  planStart     DateTime?
  planEnd       DateTime?
  actualStart   DateTime?
  actualEnd     DateTime?
  baselineId    String?
  timeEntries   TimeEntry[]
  createdAt     DateTime      @default(now())
  createdBy     String?
  updatedAt     DateTime      @updatedAt
  updatedBy     String?
  deletedAt     DateTime?
  deletedReason String?

  @@index([projectId, deletedAt])
  @@index([parentTaskId, deletedAt])
}

model ProjectChatMessage {
  id            String    @id @default(uuid())
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Restrict)
  projectId     String
  userId        String
  body          String
  tags          Json?
  reactions     Json?
  createdAt     DateTime  @default(now())
  createdBy     String?
  updatedAt     DateTime  @updatedAt
  updatedBy     String?
  deletedAt     DateTime?
  deletedReason String?

  @@index([projectId, createdAt])
}

model ProjectMilestone {
  id                String    @id @default(uuid())
  project           Project   @relation(fields: [projectId], references: [id], onDelete: Restrict)
  projectId         String
  name              String
  amount            Decimal
  billUpon          String // enum候補: date/acceptance/time
  dueDate           DateTime?
  taxRate           Decimal?
  invoiceTemplateId String?
  invoices          Invoice[]
  createdAt         DateTime  @default(now())
  createdBy         String?
  updatedAt         DateTime  @updatedAt
  updatedBy         String?
  deletedAt         DateTime?
  deletedReason     String?

  @@index([projectId, deletedAt])
  @@index([deletedAt, dueDate])
}

model RecurringProjectTemplate {
  id                     String                   @id @default(uuid())
  project                Project                  @relation(fields: [projectId], references: [id], onDelete: Restrict)
  projectId              String                   @unique
  logs                   RecurringGenerationLog[]
  frequency              String // monthly/quarterly/semiannual/annual
  defaultAmount          Decimal?
  defaultCurrency        String?
  defaultTaxRate         Decimal?
  defaultTerms           String?
  defaultMilestoneName   String?
  billUpon               String?
  dueDateRule            Json?
  shouldGenerateEstimate Boolean                  @default(true)
  shouldGenerateInvoice  Boolean                  @default(true)
  nextRunAt              DateTime?
  timezone               String?
  isActive               Boolean                  @default(true)
  createdAt              DateTime                 @default(now())
  createdBy              String?
  updatedAt              DateTime                 @updatedAt
  updatedBy              String?
}

model RecurringGenerationLog {
  id          String                   @id @default(uuid())
  template    RecurringProjectTemplate @relation(fields: [templateId], references: [id], onDelete: Restrict)
  templateId  String
  project     Project                  @relation(fields: [projectId], references: [id], onDelete: Restrict)
  projectId   String
  periodKey   String
  runAt       DateTime
  status      String
  message     String?
  estimateId  String?
  invoiceId   String?
  milestoneId String?
  createdAt   DateTime                 @default(now())
  createdBy   String?

  @@unique([templateId, periodKey])
  @@index([projectId, periodKey])
}

model Estimate {
  id              String         @id @default(uuid())
  project         Project        @relation(fields: [projectId], references: [id], onDelete: Restrict)
  projectId       String
  version         Int
  totalAmount     Decimal
  currency        String
  status          DocStatus      @default(draft)
  validUntil      DateTime?
  notes           String?
  numberingSerial Int?
  lines           EstimateLine[]
  invoices        Invoice[]
  createdAt       DateTime       @default(now())
  createdBy       String?
  updatedAt       DateTime       @updatedAt
  updatedBy       String?
  deletedAt       DateTime?
  deletedReason   String?

  @@index([projectId, status, deletedAt])
  @@index([createdAt])
}

model EstimateLine {
  id          String   @id @default(uuid())
  estimate    Estimate @relation(fields: [estimateId], references: [id])
  estimateId  String
  description String
  quantity    Decimal  @default(1)
  unitPrice   Decimal
  taxRate     Decimal?
  taskId      String?
}

model Invoice {
  id              String            @id @default(uuid())
  project         Project           @relation(fields: [projectId], references: [id], onDelete: Restrict)
  projectId       String
  estimate        Estimate?         @relation(fields: [estimateId], references: [id], onDelete: SetNull)
  estimateId      String? // 見積なし請求を許容
  milestone       ProjectMilestone? @relation(fields: [milestoneId], references: [id], onDelete: SetNull)
  milestoneId     String? // 任意。未紐付けは納品請求漏れチェック対象
  invoiceNo       String            @unique
  issueDate       DateTime?
  dueDate         DateTime?
  currency        String
  totalAmount     Decimal
  status          DocStatus         @default(draft)
  pdfUrl          String?
  emailMessageId  String?
  numberingSerial Int?
  lines           BillingLine[]
  createdAt       DateTime          @default(now())
  createdBy       String?
  updatedAt       DateTime          @updatedAt
  updatedBy       String?
  deletedAt       DateTime?
  deletedReason   String?

  @@index([projectId, status, deletedAt])
  @@index([issueDate])
  @@index([dueDate])
}

model BillingLine {
  id             String   @id @default(uuid())
  invoice        Invoice  @relation(fields: [invoiceId], references: [id])
  invoiceId      String
  description    String
  quantity       Decimal  @default(1)
  unitPrice      Decimal
  taxRate        Decimal?
  taskId         String?
  timeEntryRange String?
}

model PurchaseOrder {
  id              String              @id @default(uuid())
  project         Project             @relation(fields: [projectId], references: [id], onDelete: Restrict)
  projectId       String
  vendor          Vendor              @relation(fields: [vendorId], references: [id], onDelete: Restrict)
  vendorId        String
  poNo            String              @unique
  issueDate       DateTime?
  dueDate         DateTime?
  currency        String
  totalAmount     Decimal
  status          DocStatus           @default(draft)
  pdfUrl          String?
  numberingSerial Int?
  lines           PurchaseOrderLine[]
  createdAt       DateTime            @default(now())
  createdBy       String?
  updatedAt       DateTime            @updatedAt
  updatedBy       String?
  deletedAt       DateTime?
  deletedReason   String?

  @@index([projectId, status, deletedAt])
  @@index([vendorId, status, deletedAt])
  @@index([issueDate])
  @@index([dueDate])
}

model PurchaseOrderLine {
  id              String        @id @default(uuid())
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  purchaseOrderId String
  description     String
  quantity        Decimal       @default(1)
  unitPrice       Decimal
  taxRate         Decimal?
  taskId          String?
  expenseId       String?
}

model VendorQuote {
  id            String    @id @default(uuid())
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Restrict)
  projectId     String
  vendor        Vendor    @relation(fields: [vendorId], references: [id], onDelete: Restrict)
  vendorId      String
  quoteNo       String?
  issueDate     DateTime?
  currency      String
  totalAmount   Decimal
  status        DocStatus @default(received)
  documentUrl   String?
  createdAt     DateTime  @default(now())
  createdBy     String?
  updatedAt     DateTime  @updatedAt
  updatedBy     String?
  deletedAt     DateTime?
  deletedReason String?

  @@index([projectId, status, deletedAt])
  @@index([vendorId, status, deletedAt])
  @@index([issueDate])
}

model VendorInvoice {
  id              String    @id @default(uuid())
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Restrict)
  projectId       String
  vendor          Vendor    @relation(fields: [vendorId], references: [id], onDelete: Restrict)
  vendorId        String
  vendorInvoiceNo String?
  receivedDate    DateTime?
  dueDate         DateTime?
  currency        String
  totalAmount     Decimal
  status          DocStatus @default(received)
  documentUrl     String?
  numberingSerial Int?
  createdAt       DateTime  @default(now())
  createdBy       String?
  updatedAt       DateTime  @updatedAt
  updatedBy       String?
  deletedAt       DateTime?
  deletedReason   String?

  @@index([projectId, status, deletedAt])
  @@index([vendorId, status, deletedAt])
  @@index([receivedDate])
  @@index([dueDate])
}

model TimeEntry {
  id            String       @id @default(uuid())
  project       Project      @relation(fields: [projectId], references: [id], onDelete: Restrict)
  projectId     String
  task          ProjectTask? @relation(fields: [taskId], references: [id], onDelete: SetNull)
  taskId        String?
  userId        String
  workDate      DateTime
  minutes       Int
  workType      String?
  location      String?
  notes         String?
  status        TimeStatus   @default(submitted)
  approvedBy    String?
  approvedAt    DateTime?
  createdAt     DateTime     @default(now())
  createdBy     String?
  updatedAt     DateTime     @updatedAt
  updatedBy     String?
  deletedAt     DateTime?
  deletedReason String?

  @@index([projectId, workDate, deletedAt])
  @@index([userId, workDate])
  @@index([status])
}

model RateCard {
  id        String    @id @default(uuid())
  project   Project?  @relation(fields: [projectId], references: [id])
  projectId String?
  role      String
  workType  String?
  unitPrice Decimal
  validFrom DateTime
  validTo   DateTime?
  currency  String
}

model Expense {
  id            String    @id @default(uuid())
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Restrict)
  projectId     String
  userId        String
  category      String
  amount        Decimal
  currency      String
  incurredOn    DateTime
  isShared      Boolean   @default(false)
  status        DocStatus @default(draft)
  receiptUrl    String?
  createdAt     DateTime  @default(now())
  createdBy     String?
  updatedAt     DateTime  @updatedAt
  updatedBy     String?
  deletedAt     DateTime?
  deletedReason String?

  @@index([projectId, deletedAt])
  @@index([userId, incurredOn])
  @@index([status])
}

model LeaveRequest {
  id        String      @id @default(uuid())
  userId    String
  leaveType String
  startDate DateTime
  endDate   DateTime
  hours     Int?
  status    LeaveStatus @default(draft)
  notes     String?
  createdAt DateTime    @default(now())
  createdBy String?
  updatedAt DateTime    @updatedAt
  updatedBy String?

  @@index([userId, startDate])
  @@index([status])
}

model ApprovalRule {
  id         String             @id @default(uuid())
  flowType   FlowType
  conditions Json // amountMin/amountMax/isRecurring/skipUnder/projectType/customerId/orgUnitId/flowFlags
  steps      Json // [{stepOrder, approverGroupId?, approverUserId?, parallelKey?}]
  instances  ApprovalInstance[]
  createdAt  DateTime           @default(now())
  createdBy  String?
  updatedAt  DateTime           @updatedAt
  updatedBy  String?

  @@index([flowType])
}

model ApprovalInstance {
  id          String         @id @default(uuid())
  flowType    FlowType
  targetTable String
  targetId    String
  project     Project?       @relation(fields: [projectId], references: [id], onDelete: SetNull)
  projectId   String?
  status      DocStatus      @default(pending_qa)
  currentStep Int?
  rule        ApprovalRule   @relation(fields: [ruleId], references: [id])
  ruleId      String
  steps       ApprovalStep[]
  createdAt   DateTime       @default(now())
  createdBy   String?
  updatedAt   DateTime       @updatedAt
  updatedBy   String?

  @@index([projectId])
}

model ApprovalStep {
  id              String           @id @default(uuid())
  instance        ApprovalInstance @relation(fields: [instanceId], references: [id])
  instanceId      String
  stepOrder       Int
  approverGroupId String?
  approverUserId  String?
  status          DocStatus        @default(pending_qa)
  actedBy         String?
  actedAt         DateTime?
  createdAt       DateTime         @default(now())
  createdBy       String?
  updatedAt       DateTime         @updatedAt
  updatedBy       String?

  @@index([instanceId])
  @@index([status])
}

model AlertSetting {
  id               String    @id @default(uuid())
  type             AlertType
  threshold        Decimal
  period           String // day/week/month
  scopeProjectId   String?
  recipients       Json // emails/roles/users
  channels         Json // email/dashboard/ext_future
  remindAfterHours Int?
  isEnabled        Boolean   @default(true)
  alerts           Alert[]
  createdAt        DateTime  @default(now())
  createdBy        String?
  updatedAt        DateTime  @updatedAt
  updatedBy        String?
}

model Alert {
  id           String       @id @default(uuid())
  setting      AlertSetting @relation(fields: [settingId], references: [id])
  settingId    String
  targetRef    String
  triggeredAt  DateTime     @default(now())
  reminderAt   DateTime?
  status       String       @default("open")
  sentChannels Json?
  sentResult   Json?
  createdAt    DateTime     @default(now())
  createdBy    String?
  updatedAt    DateTime     @updatedAt
  updatedBy    String?

  @@index([settingId])
}

model DocTemplateSetting {
  id            String       @id @default(uuid())
  kind          TemplateKind
  templateId    String
  numberRule    String
  layoutConfig  Json?
  logoUrl       String?
  signatureText String?
  isDefault     Boolean      @default(false)
  createdAt     DateTime     @default(now())
  createdBy     String?
  updatedAt     DateTime     @updatedAt
  updatedBy     String?

  @@index([kind])
}

model DocumentSendLog {
  id                String       @id @default(uuid())
  kind              TemplateKind
  targetTable       String
  targetId          String
  channel           String
  status            String
  recipients        Json?
  templateId        String?
  pdfUrl            String?
  providerMessageId String?
  error             String?
  metadata          Json?
  createdAt         DateTime     @default(now())
  createdBy         String?

  @@index([targetTable, targetId])
  @@index([createdAt])
  @@index([targetTable, targetId, createdAt])
}

model DailyReport {
  id               String   @id @default(uuid())
  userId           String
  reportDate       DateTime
  content          String
  linkedProjectIds Json?
  status           String?
  createdAt        DateTime @default(now())
  createdBy        String?
  updatedAt        DateTime @updatedAt
  updatedBy        String?
}

model WellbeingEntry {
  id                String   @id @default(uuid())
  userId            String
  entryDate         DateTime
  status            String // good/not_good
  helpRequested     Boolean  @default(false)
  notes             String?
  visibilityGroupId String
  createdAt         DateTime @default(now())
  createdBy         String?
  updatedAt         DateTime @updatedAt
  updatedBy         String?

  @@index([userId, entryDate])
}

model NumberSequence {
  id            String   @id @default(uuid())
  kind          String // estimate/invoice/delivery/purchase_order/vendor_quote/vendor_invoice
  year          Int
  month         Int
  currentSerial Int
  version       Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([kind, year, month])
}

model AuditLog {
  id          String   @id @default(uuid())
  action      String
  userId      String?
  targetTable String?
  targetId    String?
  metadata    Json?
  createdAt   DateTime @default(now())

  @@index([targetTable, targetId])
  @@index([action])
}
