name: ESLint 10 Readiness Watch

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 1"

permissions:
  contents: read
  issues: write

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: 20.19.0

      - name: Check eslint@10 readiness
        id: check
        run: |
          mkdir -p tmp
          set +e
          STRICT=0 ./scripts/check-eslint10-readiness.sh > tmp/eslint10-readiness.log 2>&1
          status=$?
          cat tmp/eslint10-readiness.log

          extract() {
            local key="$1"
            local value
            value="$(grep -E "^${key}:" tmp/eslint10-readiness.log | tail -n1 | sed "s/^${key}:[[:space:]]*//")"
            if [[ -z "${value}" ]]; then
              echo "UNKNOWN"
            else
              echo "${value}"
            fi
          }

          ready="$(extract ready)"
          plugin_peer="$(extract pluginPeerEslint)"
          parser_peer="$(extract parserPeerEslint)"
          react_plugin_peer="$(extract reactPluginPeerEslint)"
          react_hooks_plugin_peer="$(extract reactHooksPluginPeerEslint)"

          echo "status=${status}" >> "$GITHUB_OUTPUT"
          echo "ready=${ready}" >> "$GITHUB_OUTPUT"
          echo "plugin_peer<<EOF" >> "$GITHUB_OUTPUT"
          echo "${plugin_peer}" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          echo "parser_peer<<EOF" >> "$GITHUB_OUTPUT"
          echo "${parser_peer}" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          echo "react_plugin_peer<<EOF" >> "$GITHUB_OUTPUT"
          echo "${react_plugin_peer}" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          echo "react_hooks_plugin_peer<<EOF" >> "$GITHUB_OUTPUT"
          echo "${react_hooks_plugin_peer}" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Write summary
        run: |
          {
            echo "## eslint@10 readiness check"
            echo ""
            echo "- ready: ${{ steps.check.outputs.ready }}"
            echo "- plugin peer: \`${{ steps.check.outputs.plugin_peer }}\`"
            echo "- parser peer: \`${{ steps.check.outputs.parser_peer }}\`"
            echo "- react plugin peer: \`${{ steps.check.outputs.react_plugin_peer }}\`"
            echo "- react hooks plugin peer: \`${{ steps.check.outputs.react_hooks_plugin_peer }}\`"
            echo "- script status: ${{ steps.check.outputs.status }}"
            echo ""
            echo "Manual check command:"
            echo "\`make eslint10-readiness-check\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Warn when check script failed
        if: steps.check.outputs.status != '0'
        run: |
          echo "::warning title=eslint10 readiness check::check script failed (status=${{ steps.check.outputs.status }}). Issue #914 status comment will be attempted to be marked as BLOCKED by the following sync step."

      - name: Sync issue #914 status comment
        env:
          GH_TOKEN: ${{ github.token }}
          CHECK_STATUS: ${{ steps.check.outputs.status }}
          READY: ${{ steps.check.outputs.ready }}
          PLUGIN_PEER: ${{ steps.check.outputs.plugin_peer }}
          PARSER_PEER: ${{ steps.check.outputs.parser_peer }}
          REACT_PLUGIN_PEER: ${{ steps.check.outputs.react_plugin_peer }}
          REACT_HOOKS_PLUGIN_PEER: ${{ steps.check.outputs.react_hooks_plugin_peer }}
        run: |
          marker="<!-- eslint10-readiness-status -->"
          run_url="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          now="$(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          if [[ "${CHECK_STATUS}" == "0" ]]; then
            body="$(printf '%s\n' \
              "eslint@10 readiness 週次監視（自動更新）" \
              "" \
              "- 実行時刻: ${now}" \
              "- ready: \`${READY}\`" \
              "- @typescript-eslint/eslint-plugin peer: \`${PLUGIN_PEER}\`" \
              "- @typescript-eslint/parser peer: \`${PARSER_PEER}\`" \
              "- eslint-plugin-react peer: \`${REACT_PLUGIN_PEER}\`" \
              "- eslint-plugin-react-hooks peer: \`${REACT_HOOKS_PLUGIN_PEER}\`" \
              "- script status: \`${CHECK_STATUS}\`" \
              "" \
              "workflow run: ${run_url}" \
              "${marker}" \
            )"
          else
            body="$(printf '%s\n' \
              "eslint@10 readiness 週次監視（自動更新）" \
              "" \
              "- 実行時刻: ${now}" \
              "- status: \`BLOCKED\`" \
              "- script status: \`${CHECK_STATUS}\`" \
              "- note: チェックスクリプトが失敗したため、再開判定の詳細取得/評価に失敗し、詳細の更新を省略しました（詳細は workflow ログ/artifact を参照）。" \
              "" \
              "workflow run: ${run_url}" \
              "${marker}" \
            )"
          fi

          existing_id="$(gh api "repos/${GITHUB_REPOSITORY}/issues/914/comments" --paginate --jq '.[] | select(.user.login=="github-actions[bot]") | select(.body | contains("<!-- eslint10-readiness-status -->")) | .id' | tail -n1)"

          if [[ -n "${existing_id}" ]]; then
            gh api -X PATCH "repos/${GITHUB_REPOSITORY}/issues/comments/${existing_id}" -f body="${body}" >/dev/null
          else
            gh issue comment 914 --body "${body}" >/dev/null
          fi

      - name: Notify issue #914 when ready
        if: steps.check.outputs.status == '0' && steps.check.outputs.ready == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          PLUGIN_PEER: ${{ steps.check.outputs.plugin_peer }}
          PARSER_PEER: ${{ steps.check.outputs.parser_peer }}
          REACT_PLUGIN_PEER: ${{ steps.check.outputs.react_plugin_peer }}
          REACT_HOOKS_PLUGIN_PEER: ${{ steps.check.outputs.react_hooks_plugin_peer }}
        run: |
          marker="<!-- eslint10-readiness-watch -->"
          if gh api "repos/${GITHUB_REPOSITORY}/issues/914/comments" --paginate --jq '.[].body' | grep -F "${marker}" >/dev/null 2>&1; then
            echo "Issue #914 already has readiness notification."
            exit 0
          fi
          gh issue comment 914 --body "$(cat <<EOF
          eslint@10 再開条件を検知しました。

          - @typescript-eslint/eslint-plugin peerDependencies.eslint: \`${PLUGIN_PEER}\`
          - @typescript-eslint/parser peerDependencies.eslint: \`${PARSER_PEER}\`
          - eslint-plugin-react peerDependencies.eslint: \`${REACT_PLUGIN_PEER}\`
          - eslint-plugin-react-hooks peerDependencies.eslint: \`${REACT_HOOKS_PLUGIN_PEER}\`

          #914 の未完了タスク（ignore解除・Dependabot再開）を実施してください。
          <!-- eslint10-readiness-watch -->
          EOF
          )"

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: eslint10-readiness-${{ github.run_id }}
          path: tmp/eslint10-readiness.log
          if-no-files-found: error
          retention-days: 14
