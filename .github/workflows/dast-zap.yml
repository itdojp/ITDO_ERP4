name: DAST (OWASP ZAP)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * 1"

permissions:
  contents: read

jobs:
  zap-baseline:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: 20.19.0

      - run: npm ci --prefix packages/backend
      - run: npx --prefix packages/backend prisma generate --config packages/backend/prisma.config.ts
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/postgres?schema=public
      - run: npx --prefix packages/backend prisma db push --config packages/backend/prisma.config.ts
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/postgres?schema=public
      - run: npm run build --prefix packages/backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/postgres?schema=public
      - name: Export OpenAPI for ZAP API scan
        run: node scripts/export-openapi.mjs --out tmp/zap-report/openapi.json
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/postgres?schema=public

      - name: Start backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/postgres?schema=public
          PORT: "3002"
          ALLOWED_ORIGINS: http://localhost:5173,http://127.0.0.1:5173
          AUTH_MODE: header
        run: |
          mkdir -p tmp
          node packages/backend/dist/index.js > tmp/dast-backend.log 2>&1 &
          echo $! > tmp/dast-backend.pid

      - name: Wait backend health
        run: |
          for i in $(seq 1 60); do
            if curl -fsS "http://localhost:3002/healthz" >/dev/null 2>&1; then
              exit 0
            fi
            sleep 1
          done
          echo "backend not ready" >&2
          tail -n 200 tmp/dast-backend.log >&2 || true
          exit 1

      - name: Run ZAP baseline (non-blocking)
        continue-on-error: true
        run: |
          mkdir -p tmp/zap-report
          docker run --rm --network=host \
            -v "$PWD/tmp/zap-report:/zap/wrk/:rw" \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
              -t "http://127.0.0.1:3002/readyz" \
              -J "zap-report.json" \
              -r "zap-report.html" \
              -w "zap-report.md" \
              -m 1 \
              -I

      - name: Run ZAP API scan (OpenAPI, non-blocking)
        continue-on-error: true
        run: |
          docker run --rm --network=host \
            -v "$PWD/tmp/zap-report:/zap/wrk/:rw" \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-api-scan.py \
              -t "/zap/wrk/openapi.json" \
              -f "openapi" \
              -J "zap-api-report.json" \
              -r "zap-api-report.html" \
              -w "zap-api-report.md" \
              -z "\
                -config replacer.full_list(0).description=x-user-id \
                -config replacer.full_list(0).enabled=true \
                -config replacer.full_list(0).matchtype=REQ_HEADER \
                -config replacer.full_list(0).matchstr=x-user-id \
                -config replacer.full_list(0).replacement=zap-security-bot \
                -config replacer.full_list(1).description=x-roles \
                -config replacer.full_list(1).enabled=true \
                -config replacer.full_list(1).matchtype=REQ_HEADER \
                -config replacer.full_list(1).matchstr=x-roles \
                -config replacer.full_list(1).replacement=admin,mgmt,user" \
              -I

      - name: Upload ZAP report artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: zap-report-${{ github.run_id }}
          path: tmp/zap-report/*
          if-no-files-found: warn
          retention-days: 30

      - name: Upload DAST backend logs
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: dast-backend-log-${{ github.run_id }}
          path: tmp/dast-backend.log
          if-no-files-found: warn
          retention-days: 14

      - name: Stop backend
        if: always()
        run: |
          if [ -f tmp/dast-backend.pid ]; then
            kill "$(cat tmp/dast-backend.pid)" >/dev/null 2>&1 || true
          fi
