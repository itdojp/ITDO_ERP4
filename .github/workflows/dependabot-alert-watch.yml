name: Dependabot Alert Watch

on:
  workflow_dispatch:
  schedule:
    - cron: "30 3 * * 1"

permissions:
  contents: write
  issues: write
  pull-requests: write
  security-events: read

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: 20.19.0

      - name: Check dependabot alerts
        id: check
        env:
          GH_TOKEN: ${{ secrets.DEPENDABOT_ALERTS_TOKEN != '' && secrets.DEPENDABOT_ALERTS_TOKEN || github.token }}
          DEPENDABOT_ALERTS_TOKEN_SET: ${{ secrets.DEPENDABOT_ALERTS_TOKEN != '' }}
        run: |
          mkdir -p tmp
          set +e
          STRICT=0 ./scripts/check-dependabot-alerts.sh > tmp/dependabot-alert-watch.log 2>&1
          status=$?
          cat tmp/dependabot-alert-watch.log

          extract() {
            local key="$1"
            local value
            value="$(grep -E "^${key}:" tmp/dependabot-alert-watch.log | tail -n1 | sed "s/^${key}:[[:space:]]*//")"
            if [[ -z "${value}" ]]; then
              echo "UNKNOWN"
            else
              echo "${value}"
            fi
          }

          detect_failure_reason() {
            if [[ "${status}" == "0" ]]; then
              echo "NONE"
              return
            fi
            if [[ "${DEPENDABOT_ALERTS_TOKEN_SET}" != "true" ]] && grep -qi 'Resource not accessible by integration' tmp/dependabot-alert-watch.log; then
              echo "MISSING_DEPENDABOT_ALERTS_TOKEN"
              return
            fi
            if grep -qi 'Resource not accessible by integration' tmp/dependabot-alert-watch.log; then
              echo "PERMISSION_DENIED"
              return
            fi
            if grep -qi 'Bad credentials' tmp/dependabot-alert-watch.log; then
              echo "BAD_CREDENTIALS"
              return
            fi
            if grep -qi 'gh CLI is required' tmp/dependabot-alert-watch.log; then
              echo "MISSING_GH"
              return
            fi
            if grep -qi 'npm is required' tmp/dependabot-alert-watch.log; then
              echo "MISSING_NPM"
              return
            fi
            if grep -qi 'node is required' tmp/dependabot-alert-watch.log; then
              echo "MISSING_NODE"
              return
            fi
            if grep -qi 'jq is required' tmp/dependabot-alert-watch.log; then
              echo "MISSING_JQ"
              return
            fi
            if grep -qi 'Invalid GITHUB_REPOSITORY' tmp/dependabot-alert-watch.log; then
              echo "INVALID_REPOSITORY"
              return
            fi
            if grep -q 'No such file or directory' tmp/dependabot-alert-watch.log; then
              echo "NO_SUCH_FILE_OR_DIRECTORY"
              return
            fi
            echo "UNKNOWN_FAILURE"
          }

          failure_reason="$(detect_failure_reason)"
          echo "status=${status}" >> "$GITHUB_OUTPUT"
          echo "failure_reason=${failure_reason}" >> "$GITHUB_OUTPUT"
          echo "alert_low_state=$(extract alertLowState)" >> "$GITHUB_OUTPUT"
          echo "alert_low_ghsa=$(extract alertLowGhsa)" >> "$GITHUB_OUTPUT"
          echo "alert_high_state=$(extract alertHighState)" >> "$GITHUB_OUTPUT"
          echo "alert_high_ghsa=$(extract alertHighGhsa)" >> "$GITHUB_OUTPUT"
          echo "qs_version=$(extract qsResolvedVersion)" >> "$GITHUB_OUTPUT"
          echo "qs_patched=$(extract qsPatched)" >> "$GITHUB_OUTPUT"
          echo "fast_xml_version=$(extract fastXmlResolvedVersion)" >> "$GITHUB_OUTPUT"
          echo "fast_xml_patched=$(extract fastXmlPatched)" >> "$GITHUB_OUTPUT"
          echo "googleapis_current=$(extract googleapisCurrent)" >> "$GITHUB_OUTPUT"
          echo "googleapis_latest=$(extract googleapisLatest)" >> "$GITHUB_OUTPUT"
          echo "googleapis_common_current=$(extract googleapisCommonCurrent)" >> "$GITHUB_OUTPUT"
          echo "googleapis_common_latest=$(extract googleapisCommonLatest)" >> "$GITHUB_OUTPUT"
          echo "upstream_updated=$(extract upstreamUpdated)" >> "$GITHUB_OUTPUT"
          echo "action_required=$(extract actionRequired)" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Write summary
        run: |
          {
            echo "## Dependabot alert watch"
            echo ""
            echo "| item | value |"
            echo "| --- | --- |"
            echo "| alert #10 state | \`${{ steps.check.outputs.alert_low_state }}\` |"
            echo "| alert #10 GHSA | \`${{ steps.check.outputs.alert_low_ghsa }}\` |"
            echo "| alert #11 state | \`${{ steps.check.outputs.alert_high_state }}\` |"
            echo "| alert #11 GHSA | \`${{ steps.check.outputs.alert_high_ghsa }}\` |"
            echo "| qs resolved version | \`${{ steps.check.outputs.qs_version }}\` |"
            echo "| qs patched | \`${{ steps.check.outputs.qs_patched }}\` |"
            echo "| fast-xml-parser resolved version | \`${{ steps.check.outputs.fast_xml_version }}\` |"
            echo "| fast-xml-parser patched | \`${{ steps.check.outputs.fast_xml_patched }}\` |"
            echo "| googleapis current/latest | \`${{ steps.check.outputs.googleapis_current }}\` / \`${{ steps.check.outputs.googleapis_latest }}\` |"
            echo "| googleapis-common current/latest | \`${{ steps.check.outputs.googleapis_common_current }}\` / \`${{ steps.check.outputs.googleapis_common_latest }}\` |"
            echo "| upstream updated | \`${{ steps.check.outputs.upstream_updated }}\` |"
            echo "| action required | \`${{ steps.check.outputs.action_required }}\` |"
            echo "| script status | \`${{ steps.check.outputs.status }}\` |"
            echo "| result reason | \`${{ steps.check.outputs.failure_reason }}\` |"
            echo ""
            echo "Manual check command:"
            echo "\`make dependabot-alerts-check\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Warn when check script failed
        if: steps.check.outputs.status != '0'
        env:
          FAILURE_REASON: ${{ steps.check.outputs.failure_reason }}
        run: |
          if [[ "${FAILURE_REASON}" == "MISSING_DEPENDABOT_ALERTS_TOKEN" ]]; then
            echo "::warning title=dependabot alert watch::check script failed (status=${{ steps.check.outputs.status }}, reason=${FAILURE_REASON}). Set DEPENDABOT_ALERTS_TOKEN to restore issue sync."
          elif [[ "${FAILURE_REASON}" == "PERMISSION_DENIED" ]]; then
            echo "::warning title=dependabot alert watch::check script failed (status=${{ steps.check.outputs.status }}, reason=${FAILURE_REASON}). Update DEPENDABOT_ALERTS_TOKEN permissions to restore issue sync."
          elif [[ "${FAILURE_REASON}" == "BAD_CREDENTIALS" ]]; then
            echo "::warning title=dependabot alert watch::check script failed (status=${{ steps.check.outputs.status }}, reason=${FAILURE_REASON}). Verify DEPENDABOT_ALERTS_TOKEN value and permissions."
          else
            echo "::warning title=dependabot alert watch::check script failed (status=${{ steps.check.outputs.status }}, reason=${FAILURE_REASON}). Check workflow logs/artifacts and rerun after fixing."
          fi

      - name: Sync issue #1153 status comment
        env:
          GH_TOKEN: ${{ github.token }}
          CHECK_STATUS: ${{ steps.check.outputs.status }}
          FAILURE_REASON: ${{ steps.check.outputs.failure_reason }}
          ALERT_LOW_STATE: ${{ steps.check.outputs.alert_low_state }}
          ALERT_LOW_GHSA: ${{ steps.check.outputs.alert_low_ghsa }}
          ALERT_HIGH_STATE: ${{ steps.check.outputs.alert_high_state }}
          ALERT_HIGH_GHSA: ${{ steps.check.outputs.alert_high_ghsa }}
          QS_VERSION: ${{ steps.check.outputs.qs_version }}
          QS_PATCHED: ${{ steps.check.outputs.qs_patched }}
          FAST_XML_VERSION: ${{ steps.check.outputs.fast_xml_version }}
          FAST_XML_PATCHED: ${{ steps.check.outputs.fast_xml_patched }}
          GOOGLEAPIS_CURRENT: ${{ steps.check.outputs.googleapis_current }}
          GOOGLEAPIS_LATEST: ${{ steps.check.outputs.googleapis_latest }}
          GOOGLEAPIS_COMMON_CURRENT: ${{ steps.check.outputs.googleapis_common_current }}
          GOOGLEAPIS_COMMON_LATEST: ${{ steps.check.outputs.googleapis_common_latest }}
          UPSTREAM_UPDATED: ${{ steps.check.outputs.upstream_updated }}
          ACTION_REQUIRED: ${{ steps.check.outputs.action_required }}
        run: |
          marker="<!-- dependabot-alert-watch -->"
          run_url="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          now="$(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          if [[ "${CHECK_STATUS}" == "0" ]]; then
            body="$(printf '%s\n' \
              "Dependabot alert 週次監視（自動更新）" \
              "" \
              "- 実行時刻: ${now}" \
              "- alert #10 (${ALERT_LOW_GHSA}): \`${ALERT_LOW_STATE}\`" \
              "- alert #11 (${ALERT_HIGH_GHSA}): \`${ALERT_HIGH_STATE}\`" \
              "- qs resolved/patched: \`${QS_VERSION}\` / \`${QS_PATCHED}\`" \
              "- fast-xml-parser resolved/patched: \`${FAST_XML_VERSION}\` / \`${FAST_XML_PATCHED}\`" \
              "- googleapis current/latest: \`${GOOGLEAPIS_CURRENT}\` / \`${GOOGLEAPIS_LATEST}\`" \
              "- googleapis-common current/latest: \`${GOOGLEAPIS_COMMON_CURRENT}\` / \`${GOOGLEAPIS_COMMON_LATEST}\`" \
              "- upstream updated: \`${UPSTREAM_UPDATED}\`" \
              "- action required: \`${ACTION_REQUIRED}\`" \
              "- script status: \`${CHECK_STATUS}\`" \
              "" \
              "workflow run: ${run_url}" \
              "${marker}" \
            )"
          else
            action_message="workflow ログ/artifact を確認し、失敗要因を解消して再実行してください。"
            if [[ "${FAILURE_REASON}" == "MISSING_DEPENDABOT_ALERTS_TOKEN" ]]; then
              action_message="\`DEPENDABOT_ALERTS_TOKEN\`（Dependabot alerts 読み取り権限付き）を repository secret に設定して再実行してください。"
            elif [[ "${FAILURE_REASON}" == "PERMISSION_DENIED" ]]; then
              action_message="\`DEPENDABOT_ALERTS_TOKEN\` と権限設定を確認して再実行してください。"
            fi
            body="$(printf '%s\n' \
              "Dependabot alert 週次監視（自動更新）" \
              "" \
              "- 実行時刻: ${now}" \
              "- status: \`BLOCKED\`" \
              "- script status: \`${CHECK_STATUS}\`" \
              "- result reason: \`${FAILURE_REASON}\`" \
              "- note: チェックスクリプトが失敗したため、#1153 の状態同期をスキップしました。" \
              "- action: ${action_message}" \
              "" \
              "workflow run: ${run_url}" \
              "${marker}" \
            )"
          fi

          existing_id="$(gh api "repos/${GITHUB_REPOSITORY}/issues/1153/comments" --paginate --jq '.[] | select(.user.login=="github-actions[bot]") | select(.body | contains("<!-- dependabot-alert-watch -->")) | .id' | tail -n1)"

          if [[ -n "${existing_id}" ]]; then
            gh api -X PATCH "repos/${GITHUB_REPOSITORY}/issues/comments/${existing_id}" -f body="${body}" >/dev/null
          else
            gh issue comment 1153 --body "${body}" >/dev/null
          fi

      - name: Sync issue #1176 token readiness
        env:
          GH_TOKEN: ${{ github.token }}
          CHECK_STATUS: ${{ steps.check.outputs.status }}
          FAILURE_REASON: ${{ steps.check.outputs.failure_reason }}
        run: |
          issue_number="1176"
          marker="<!-- dependabot-token-readiness -->"
          run_url="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          now="$(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          current_state="$(gh api "repos/${GITHUB_REPOSITORY}/issues/${issue_number}" --jq '.state')"

          token_blocked=false
          case "${FAILURE_REASON}" in
            MISSING_DEPENDABOT_ALERTS_TOKEN|PERMISSION_DENIED|BAD_CREDENTIALS)
              token_blocked=true
              ;;
          esac

          if [[ "${CHECK_STATUS}" == "0" ]]; then
            body="$(printf '%s\n' \
              "Dependabot token readiness（自動更新）" \
              "" \
              "- 実行時刻: ${now}" \
              "- status: \`READY\`" \
              "- script status: \`${CHECK_STATUS}\`" \
              "- result reason: \`NONE\`" \
              "- note: Dependabot Alert API にアクセス可能なため、#1153 の状態同期が継続実行されます。" \
              "" \
              "workflow run: ${run_url}" \
              "${marker}" \
            )"
          else
            action_message="workflow ログ/artifact を確認し、失敗要因を解消して再実行してください。"
            if [[ "${FAILURE_REASON}" == "MISSING_DEPENDABOT_ALERTS_TOKEN" ]]; then
              action_message="\`DEPENDABOT_ALERTS_TOKEN\`（Dependabot alerts 読み取り権限付き）を repository secret に設定して再実行してください。"
            elif [[ "${FAILURE_REASON}" == "PERMISSION_DENIED" ]] || [[ "${FAILURE_REASON}" == "BAD_CREDENTIALS" ]]; then
              action_message="\`DEPENDABOT_ALERTS_TOKEN\` の値と権限設定を確認して再実行してください。"
            fi
            body="$(printf '%s\n' \
              "Dependabot token readiness（自動更新）" \
              "" \
              "- 実行時刻: ${now}" \
              "- status: \`BLOCKED\`" \
              "- script status: \`${CHECK_STATUS}\`" \
              "- result reason: \`${FAILURE_REASON}\`" \
              "- action: ${action_message}" \
              "" \
              "workflow run: ${run_url}" \
              "${marker}" \
            )"
          fi

          existing_id="$(gh api "repos/${GITHUB_REPOSITORY}/issues/${issue_number}/comments" --paginate --jq '.[] | select(.user.login=="github-actions[bot]") | select(.body | contains("<!-- dependabot-token-readiness -->")) | .id' | tail -n1)"

          if [[ -n "${existing_id}" ]]; then
            gh api -X PATCH "repos/${GITHUB_REPOSITORY}/issues/comments/${existing_id}" -f body="${body}" >/dev/null
          else
            gh issue comment "${issue_number}" --body "${body}" >/dev/null
          fi

          if [[ "${CHECK_STATUS}" == "0" ]] && [[ "${current_state}" == "open" ]]; then
            gh api -X PATCH "repos/${GITHUB_REPOSITORY}/issues/${issue_number}" -f state='closed' >/dev/null
            exit 0
          fi

          if [[ "${CHECK_STATUS}" != "0" ]] && [[ "${token_blocked}" == "true" ]] && [[ "${current_state}" == "closed" ]]; then
            gh api -X PATCH "repos/${GITHUB_REPOSITORY}/issues/${issue_number}" -f state='open' >/dev/null
          fi

      - name: Keep issue #1153 state in sync
        if: steps.check.outputs.status == '0'
        env:
          GH_TOKEN: ${{ github.token }}
          ALERT_LOW_STATE: ${{ steps.check.outputs.alert_low_state }}
          ACTION_REQUIRED: ${{ steps.check.outputs.action_required }}
        run: |
          issue_number="1153"
          if [[ -z "${ALERT_LOW_STATE}" ]] || [[ -z "${ACTION_REQUIRED}" ]]; then
            echo "Skip issue state sync because required outputs are empty."
            exit 0
          fi
          if [[ "${ACTION_REQUIRED}" != "true" ]] && [[ "${ACTION_REQUIRED}" != "false" ]]; then
            echo "Skip issue state sync because actionRequired has unexpected value: ${ACTION_REQUIRED}"
            exit 0
          fi

          current_state="$(gh api "repos/${GITHUB_REPOSITORY}/issues/${issue_number}" --jq '.state')"

          if [[ "${ACTION_REQUIRED}" == "true" ]] || [[ "${ALERT_LOW_STATE}" == "OPEN" ]]; then
            if [[ "${current_state}" == "closed" ]]; then
              gh api -X PATCH "repos/${GITHUB_REPOSITORY}/issues/${issue_number}" -f state='open' >/dev/null
              gh issue comment "${issue_number}" --body "Dependabot alert watch により再オープンしました（actionRequired=true または alert #10 が OPEN）。" >/dev/null
            fi
            exit 0
          fi

          if [[ "${ACTION_REQUIRED}" == "false" ]] && [[ "${ALERT_LOW_STATE}" != "OPEN" ]] && [[ "${current_state}" == "open" ]]; then
            gh issue comment "${issue_number}" --body "Dependabot alert watch で alert #10 が OPEN でないこと、および actionRequired=false を確認したためクローズします。" >/dev/null
            gh api -X PATCH "repos/${GITHUB_REPOSITORY}/issues/${issue_number}" -f state='closed' >/dev/null
          fi

      - name: Create dependency update PR when upstream updated
        if: steps.check.outputs.status == '0' && steps.check.outputs.upstream_updated == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          GOOGLEAPIS_CURRENT: ${{ steps.check.outputs.googleapis_current }}
          GOOGLEAPIS_LATEST: ${{ steps.check.outputs.googleapis_latest }}
          GOOGLEAPIS_COMMON_CURRENT: ${{ steps.check.outputs.googleapis_common_current }}
          GOOGLEAPIS_COMMON_LATEST: ${{ steps.check.outputs.googleapis_common_latest }}
        run: |
          sanitize_branch_part() {
            echo "$1" | tr -c '[:alnum:]._+-' '-'
          }

          is_valid_version() {
            local value="$1"
            [[ "${value}" =~ ^[0-9]+(\.[0-9]+){1,3}([-.][0-9A-Za-z.+-]+)?$ ]]
          }

          require_version_var() {
            local name="$1"
            local value="${!name:-}"
            if [[ -z "${value}" ]] || [[ "${value}" == "UNKNOWN" ]] || [[ "${value}" == "unknown" ]]; then
              echo "Invalid ${name}: ${value}" >&2
              exit 1
            fi
            if ! is_valid_version "${value}"; then
              echo "Unexpected ${name}: ${value}" >&2
              exit 1
            fi
          }

          require_version_var "GOOGLEAPIS_CURRENT"
          require_version_var "GOOGLEAPIS_LATEST"
          require_version_var "GOOGLEAPIS_COMMON_CURRENT"
          require_version_var "GOOGLEAPIS_COMMON_LATEST"

          googleapis_latest_slug="$(sanitize_branch_part "${GOOGLEAPIS_LATEST}")"
          googleapis_common_latest_slug="$(sanitize_branch_part "${GOOGLEAPIS_COMMON_LATEST}")"
          base_branch_name="chore/dependabot-upstream-${googleapis_latest_slug}-${googleapis_common_latest_slug}"
          branch="${base_branch_name}"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git fetch origin main

          merged_pr_number="$(gh pr list --state merged --head "${base_branch_name}" --base main --json number --jq '.[0].number // empty')"
          if [[ -n "${merged_pr_number}" ]]; then
            # A merged PR already exists for this base branch. Use a unique branch name.
            branch="${base_branch_name}-${GITHUB_RUN_ID}"
            git switch -c "${branch}" origin/main
          elif git ls-remote --exit-code --heads origin "${branch}" >/dev/null 2>&1; then
            git fetch origin "${branch}:${branch}"
            git switch "${branch}"
            if ! git merge --ff-only origin/main; then
              git merge --no-edit origin/main
            fi
          else
            git switch -c "${branch}" origin/main
          fi

          if ! npm update --prefix packages/backend googleapis googleapis-common; then
            echo "npm update failed; aborting PR creation." >&2
            exit 1
          fi

          git add packages/backend/package-lock.json packages/backend/package.json
          if git diff --cached --quiet; then
            echo "No dependency changes detected after npm update. Skipping PR creation."
            exit 0
          fi

          commit_title="chore(deps): refresh googleapis lockfile"
          git commit \
            -m "${commit_title}" \
            -m "googleapis: ${GOOGLEAPIS_CURRENT} -> ${GOOGLEAPIS_LATEST}" \
            -m "googleapis-common: ${GOOGLEAPIS_COMMON_CURRENT} -> ${GOOGLEAPIS_COMMON_LATEST}"

          push_attempts=0
          push_max_attempts=3
          push_delay_seconds=5
          until git push --set-upstream origin "${branch}" --force-with-lease; do
            push_attempts=$((push_attempts + 1))
            if [[ "${push_attempts}" -ge "${push_max_attempts}" ]]; then
              echo "Failed to push branch '${branch}' after ${push_max_attempts} attempts." >&2
              exit 1
            fi
            echo "git push failed (attempt ${push_attempts}/${push_max_attempts}). Retrying in ${push_delay_seconds}s..."
            sleep "${push_delay_seconds}"
          done

          existing_pr_number="$(gh pr list --state open --head "${branch}" --base main --json number --jq '.[0].number // empty')"
          pr_title="chore(deps): upstream refresh googleapis ${GOOGLEAPIS_CURRENT} -> ${GOOGLEAPIS_LATEST}"
          pr_body="$(printf '%s\n' \
            "## 概要" \
            "- Dependabot Alert Watch で upstream 更新を検知したため、自動で lockfile 更新を作成" \
            "- 対象: \`packages/backend\`" \
            "" \
            "## 変更" \
            "- \`npm update --prefix packages/backend googleapis googleapis-common\` 実行結果を反映" \
            "- \`googleapis\`: \`${GOOGLEAPIS_CURRENT}\` -> \`${GOOGLEAPIS_LATEST}\`" \
            "- \`googleapis-common\`: \`${GOOGLEAPIS_COMMON_CURRENT}\` -> \`${GOOGLEAPIS_COMMON_LATEST}\`" \
            "" \
            "## 関連" \
            "- #1153" \
          )"

          if [[ -n "${existing_pr_number}" ]]; then
            gh pr edit "${existing_pr_number}" --title "${pr_title}" --body "${pr_body}"
            gh pr comment "${existing_pr_number}" --body "Dependabot Alert Watch により自動更新しました（latest: ${GOOGLEAPIS_LATEST} / ${GOOGLEAPIS_COMMON_LATEST}）。"
            exit 0
          fi

          closed_pr_number="$(gh pr list --state closed --head "${branch}" --base main --json number --jq '.[0].number // empty')"
          if [[ -n "${closed_pr_number}" ]]; then
            gh pr reopen "${closed_pr_number}"
            gh pr edit "${closed_pr_number}" --title "${pr_title}" --body "${pr_body}"
            gh pr comment "${closed_pr_number}" --body "Dependabot Alert Watch により再オープンして更新しました（latest: ${GOOGLEAPIS_LATEST} / ${GOOGLEAPIS_COMMON_LATEST}）。"
            exit 0
          fi

          gh pr create --base main --head "${branch}" --title "${pr_title}" --body "${pr_body}"

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: dependabot-alert-watch-${{ github.run_id }}
          path: tmp/dependabot-alert-watch.log
          if-no-files-found: error
          retention-days: 14
