name: CI

on:
  push:
    branches: ["**"]
  pull_request:
  schedule:
    - cron: "0 18 * * *"

jobs:
  backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      - run: npm install
        working-directory: packages/backend
      - run: npx prisma generate --schema=./prisma/schema.prisma
        working-directory: packages/backend
        env:
          DATABASE_URL: postgresql://user:pass@localhost:5432/postgres?schema=public
      - run: npm run build
        working-directory: packages/backend
        env:
          DATABASE_URL: postgresql://user:pass@localhost:5432/postgres?schema=public
      - run: npm run test:ci
        working-directory: packages/backend
      - run: npx prisma format --schema=./prisma/schema.prisma
        working-directory: packages/backend
        env:
          DATABASE_URL: postgresql://user:pass@localhost:5432/postgres?schema=public
      - run: npx prisma validate --schema=./prisma/schema.prisma
        working-directory: packages/backend
        env:
          DATABASE_URL: postgresql://user:pass@localhost:5432/postgres?schema=public
  frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      - run: npm install --prefix packages/frontend
      - run: npm run typecheck --prefix packages/frontend
      - run: npm run build --prefix packages/frontend
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      - run: npm install --prefix packages/backend
      - run: npm run lint --prefix packages/backend
      - run: npm run format:check --prefix packages/backend
      - run: npm install --prefix packages/frontend
      - run: npm run lint --prefix packages/frontend
      - run: npm run format:check --prefix packages/frontend
  security-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Backend audit (high/critical)
        run: |
          npm ci --prefix packages/backend
          npm audit --prefix packages/backend --audit-level=high
      - name: Frontend audit (high/critical)
        run: |
          npm ci --prefix packages/frontend
          npm audit --prefix packages/frontend --audit-level=high
  data-quality:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      - run: npm install --prefix packages/backend
      - run: npm install --prefix packages/frontend
      - run: npx --prefix packages/backend ts-node --project packages/backend/tsconfig.json scripts/data-quality-check.ts || true
  e2e-frontend:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: |
      github.event_name == 'pull_request' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'push' &&
        github.ref == format('refs/heads/{0}', github.event.repository.default_branch))
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      - run: npm ci --prefix packages/backend
      - run: npm ci --prefix packages/frontend
      - run: sudo apt-get update
      - run: sudo apt-get install -y postgresql-client
      - run: npx --prefix packages/frontend playwright install --with-deps chromium
      - name: Run frontend e2e
        env:
          E2E_DB_MODE: direct
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/postgres?schema=public
          E2E_CAPTURE: 0
          E2E_SKIP_PLAYWRIGHT_INSTALL: 1
          E2E_SCOPE: ${{ github.event_name == 'pull_request' && 'core' || 'full' }}
        run: ./scripts/e2e-frontend.sh
