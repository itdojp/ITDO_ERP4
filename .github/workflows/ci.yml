name: CI

on:
  push:
    branches: ["**"]
  pull_request:
  schedule:
    - cron: "0 18 * * *"

jobs:
  backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 18
      - run: npm install
        working-directory: packages/backend
      - run: npx prisma generate --schema=./prisma/schema.prisma
        working-directory: packages/backend
        env:
          DATABASE_URL: postgresql://user:pass@localhost:5432/postgres?schema=public
      - run: npm run build
        working-directory: packages/backend
        env:
          DATABASE_URL: postgresql://user:pass@localhost:5432/postgres?schema=public
      - run: npm run test:ci
        working-directory: packages/backend
      - run: npx prisma format --schema=./prisma/schema.prisma
        working-directory: packages/backend
        env:
          DATABASE_URL: postgresql://user:pass@localhost:5432/postgres?schema=public
      - run: npx prisma validate --schema=./prisma/schema.prisma
        working-directory: packages/backend
        env:
          DATABASE_URL: postgresql://user:pass@localhost:5432/postgres?schema=public
  frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 18
      - run: npm install --prefix packages/frontend
      - run: npm run typecheck --prefix packages/frontend
      - run: npm run build --prefix packages/frontend
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 18
      - run: npm install --prefix packages/backend
      - run: npm run lint --prefix packages/backend
      - run: npm run format:check --prefix packages/backend
      - run: npm install --prefix packages/frontend
      - run: npm run lint --prefix packages/frontend
      - run: npm run format:check --prefix packages/frontend
  security-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 18
      - run: npm ci --prefix packages/backend
      - run: npm ci --prefix packages/frontend
      - name: Generate SBOM (CycloneDX)
        run: ./scripts/export-sbom.sh --out tmp/sbom
      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ github.sha }}
          path: tmp/sbom/*.cdx.json
          if-no-files-found: error
          retention-days: 30
      - name: Backend audit (high/critical)
        run: npm audit --prefix packages/backend --audit-level=high
      - name: Frontend audit (high/critical)
        run: npm audit --prefix packages/frontend --audit-level=high
  data-quality:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 18
      - run: npm install --prefix packages/backend
      - run: npm install --prefix packages/frontend
      - run: npx --prefix packages/backend ts-node --project packages/backend/tsconfig.json scripts/data-quality-check.ts || true
  e2e-frontend:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: |
      github.event_name == 'pull_request' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'push' &&
        github.ref == format('refs/heads/{0}', github.event.repository.default_branch))
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 18
      - run: npm ci --prefix packages/backend
      - run: npm ci --prefix packages/frontend
      - run: sudo apt-get update
      - run: sudo apt-get install -y postgresql-client
      - run: npx --prefix packages/frontend playwright install --with-deps chromium
      - name: Run frontend e2e
        env:
          E2E_DB_MODE: direct
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/postgres?schema=public
          E2E_CAPTURE: 0
          E2E_SKIP_PLAYWRIGHT_INSTALL: 1
          E2E_SCOPE: ${{ github.event_name == 'pull_request' && 'core' || 'full' }}
        run: ./scripts/e2e-frontend.sh

  api-schema:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v6
        with:
          node-version: 18
      - run: npm ci --prefix packages/backend
      - run: npx --prefix packages/backend prisma generate --schema=packages/backend/prisma/schema.prisma
      - run: npm run build --prefix packages/backend
        env:
          DATABASE_URL: postgresql://user:pass@localhost:5432/postgres?schema=public
      - name: Generate OpenAPI
        run: node scripts/export-openapi.mjs --out tmp/openapi.json
      - name: Ensure OpenAPI snapshot is up to date
        run: diff -u docs/api/openapi.json tmp/openapi.json
      - name: Breaking change check (openapi-diff)
        run: |
          git fetch origin "${GITHUB_BASE_REF}" --depth=1
          if git show "origin/${GITHUB_BASE_REF}:docs/api/openapi.json" > tmp/openapi-base.json 2>/dev/null; then
            if grep -q '"type": "null"' tmp/openapi-base.json; then
              echo "base openapi contains 'type: null' (OpenAPI 3.0互換でないため) -> skipping openapi-diff"
              exit 0
            fi
            npx --prefix packages/backend openapi-diff tmp/openapi-base.json tmp/openapi.json
          else
            echo "base openapi not found; skipping breaking change check"
          fi
