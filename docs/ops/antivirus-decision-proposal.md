# 添付AVスキャン 運用判断メモ（Issue #886）

## 目的
- チャット添付AVスキャンの本番運用について、未決定項目を同一観点で比較し、判断を確定する。
- 本メモは運用判断用であり、実装仕様の正本は `docs/requirements/chat-attachments-antivirus.md`、Runbookの正本は `docs/ops/antivirus.md` とする。

## 対象
- `CHAT_ATTACHMENT_AV_PROVIDER` の本番方針
- 障害時方針（fail closed の扱い）
- 定義更新方式
- 監視/アラートしきい値
- 本番構成（clamd 配置と最小リソース）

## 判断項目と推奨

### 1. 本番方針（provider）
- 選択肢A: `disabled` 継続
- 選択肢B: `clamav` 有効化
- 推奨:
  - 直近は `disabled` 継続
  - ステージング検証完了後、判定ゲートを満たした時点で `clamav` へ切替
- 理由:
  - fail closed 運用の実影響（添付不可の業務影響）を本番前に定量化する必要があるため

### 2. 障害時方針（fail closed）
- 選択肢A: fail closed 維持（スキャナ利用不能時 503）
- 選択肢B: 例外バイパス（暫定的に保存許可）
- 推奨: 選択肢A
- 理由:
  - バイパス運用は監査/統制の複雑化と監査証跡追加コストが大きい
  - 現行実装が fail closed 前提で一貫している

### 3. 定義更新方式
- 選択肢A: `freshclam --daemon`（常時更新）
- 選択肢B: 定期ジョブ実行（例: 日次）
- 選択肢C: イメージ更新で吸収（例: 週次）
- 推奨: A + C の併用
- 理由:
  - A でシグネチャ更新の追従性を確保
  - C でエンジン更新や更新異常時の復元性を担保

### 4. 監視/アラートしきい値
- 推奨初期値:
  - clamd 応答不可が 3 分継続: Critical
  - `chat_attachment_scan_failed` が 10 分で 5 件以上: High
  - 添付 API 503 比率が 10 分窓で 1% 超: High
  - スキャン処理時間 p95 が 5 秒超（10 分継続）: Medium
- 方針:
  - ステージング結果で初期値を調整し、本番適用時に固定

### 5. 本番構成（clamd 配置）
- 選択肢A: backend 同一ホスト・別コンテナ（現行PoC構成）
- 選択肢B: 専用ホスト/専用ノード
- 推奨: 選択肢A（初期導入）
- 理由:
  - 導入速度と運用負荷のバランスが良い
  - 将来の負荷増加時に B へ移行可能
- 推奨最小リソース（初期値）:
  - clamd: 2 vCPU / 2GB RAM
  - backend とは別コンテナでリソース制限を明示

## 実行ステップ（決定まで）
1. ステージングで `make av-staging-evidence` を実行
2. `docs/test-results/chat-attachments-av-staging-template.md` に沿って結果を確認（必要なら閾値を変更して再実行）
3. 本メモの推奨値との差分を評価
4. `Issue #886` の未チェック項目を更新
5. `CHAT_ATTACHMENT_AV_PROVIDER` 本番値を確定

## 保留中の論点
- 外部ユーザ添付の想定比率（本番環境実績）
- 添付不可時の業務代替フロー（受付窓口の要否）
- 本番監視基盤でのしきい値実装可否（即時導入 or 暫定運用）
