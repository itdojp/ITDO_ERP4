# アラート設計（最小セット）

## 目的
障害を「検知→一次切り分け→復旧」できるように、発火条件と一次対応を定義する。

## 重要度（暫定）
本ドキュメントでは暫定的に以下を用いる（詳細は `docs/ops/incident-response.md` に集約する）。
- SEV1: 広範囲/重大（業務停止相当）
- SEV2: 主要導線に影響（回避策あり）
- SEV3: 限定的影響（運用で吸収可能）

## 通知チャネル（現時点）
環境依存のため、通知先は運用側で選択する（メール/ダッシュボード等）。
将来の Slack/Webhook 連携は別途。

## アラート一覧（暫定）
### 可用性/依存
- **API 5xx 率（主要導線）**
  - 条件: 5xx率 > 2% が 5分継続 → SEV2
  - 条件: 5xx率 > 10% が 2分継続 → SEV1
  - 一次対応: `/readyz` 確認、直近デプロイSHA、request-id 起点でログ確認
- **readiness NG**
  - 条件: `/readyz` が 503 が 2分継続 → SEV1
  - 一次対応: DB 稼働/接続確認、`DATABASE_URL`、Podman環境なら `./scripts/podman-poc.sh check`

### 遅延
- **p95 レイテンシ悪化（主要導線）**
  - 条件: p95 > SLO の 2倍 が 10分継続 → SEV2
  - 一次対応: 直近の重いクエリ（`pg_stat_statements`）、リクエストログの偏り確認

### 飽和
- **DB接続枯渇の兆候**
  - 条件: `pg_stat_activity` の接続数が上限の 80% 超が 10分継続 → SEV2
  - 一次対応: 接続リーク/スロークエリ確認、必要なら一時的にレート制限を強化（`RATE_LIMIT_*`）

### 正しさ（代理指標）
- **重要ジョブ失敗**
  - 条件: 重要ジョブ（アラート生成/レポート配信等）の連続失敗 → SEV2
  - 一次対応: 失敗ログ、外部依存（SMTP等）の設定確認

## ノイズ抑制（暫定）
- 最低継続時間（2〜10分）を設ける
- デプロイ直後の一過性増加は「短時間で収束するか」を確認してから SEV 判定する

## 通知テンプレに含める情報（推奨）
- 発火指標（エラー率/遅延 等）と計測窓
- 直近デプロイSHA（または tag）
- request-id（代表例）
- `/healthz` / `/readyz` の結果
- 参照Runbook: `docs/ops/incident-response.md`
