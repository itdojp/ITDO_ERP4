# TODO リスト（短期ドライブ用）

## 11/21 週（～12/10ステージングまでに着手）
- [ ] Prisma/SQL 詳細化（enum/型/FK/削除ポリシー）とスキーマPR作成（#5）
  - [x] DocStatus/TimeStatus/LeaveStatus/FlowType のenum見直しと日本語注釈追加
  - [x] FK/ON DELETE/ON UPDATE方針をテーブルごとに列挙（Project/Estimate/Invoice/Expense/TimeEntry）
  - [ ] 請求・発注・仕入系のnullable列を精査（estimateId/milestoneId/taskIdなど）
  - [ ] 監査メタ createdBy/updatedBy の扱いを統一し TODO記載
  - [ ] PRにschema.prisma + docs/requirements/schema-prisma-sketch.md 対応をまとめる
- [ ] 発番/定期案件/アラート計算のバッチ擬似コード・シーケンスを追加（#6, batch-jobs.md）
  - [ ] 採番サービスに月跨ぎリセット/オーバーフロー処理コメント追加
  - [ ] 定期案件テンプレから案件生成、請求ドラフト自動作成のシーケンス図
  - [ ] アラート（予算/残業/承認遅延/納期未請求）の擬似コードと発火→通知→サプレッションフロー
- [ ] バックエンドPoCスケルトン（APIサーバ: プロジェクト/見積/請求/タイムシート/経費登録と発番・承認フック）
  - [x] prisma clientをDI化またはモジュール共有に寄せる
  - [ ] `/projects/:id/estimates`起案→`/estimates/:id/submit`→`/invoices/:id/submit/send`のhappyパス通し
  - [ ] タイムエントリ・経費のPOST/GETと簡易フィルタ（projectId/userId/date範囲）
  - [ ] タイム修正時に承認インスタンスを起動するhookのスタブ
- [ ] フロントPoCスケルトン（Web: 日報入力、工数入力、請求ドラフト閲覧）
  - [x] APIクライアントラッパ（fetch + JSON/エラー処理）
  - [x] 日報+WBフォームのモック（入力→POST→トースト表示）
  - [x] 工数入力フォーム（project/task選択、日付、時間、場所、残業区分）と一覧リロード
  - [x] 請求ドラフト一覧+詳細モック（番号/ステータス/送信ボタン）
- [x] データ移行マッピング初版（PO im_*/acs_* → 新スキーマ、キー/シーケンス整合）
  - [x] im_project/acs_project 等のカラムと Project との対応表
  - [x] 見積/請求/発注/仕入の番号マッピングと連番採番方針
  - [x] ユーザーID/チームID→UUIDの紐付けサンプルSQL
- [ ] CI足場（lint/format/docリンクチェック）とテンプレート（Issue/PR）
  - [x] backend: eslint+prettierの最小設定と`npm run lint`
  - [x] frontend: eslint+prettierの最小設定と`npm run lint`
  - [x] markdownリンクチェック(or lychee) のJob追記
  - [x] .github/ISSUE_TEMPLATE / PULL_REQUEST_TEMPLATE 追加
- [ ] バックエンド: 番号採番サービス（number_sequencesラッパ）とメール送信Stubをユーティリティ化
  - [x] numberSequencesテーブル用のupsertエラー処理（シリアル上限、月跨ぎ）
  - [x] メール送信stub（sendInvoiceEmail/sendPurchaseOrderEmail）をservices/notifier.tsに切り出し
  - [x] send routesからstubを呼び出すよう整理
- [ ] バックエンド: 承認ルールマッチャー（条件→ステップ生成）の雛形実装
  - [x] approvalRules.conditionsの構造サンプル（金額閾値/定期案件判定/小額スキップ）
  - [x] matcher関数: 入力(FlowType, payload)→steps[] を返すスタブをservices/approval.tsへ
- [ ] バックエンド: ダッシュボード用アラートフィードAPI（メール送信Stubと同時に発報履歴保存）
  - [x] GET /alerts?projectId/&status= などの簡易フィルタ
  - [x] POST /jobs/alerts/run 内でAlertレコード保存＋notifier呼び出し
- [ ] フロント: 認証モック（Google OIDC想定のセッション+BFFダミー）
  - [ ] `/me`へのfetchとロール/グループ保持、未ログイン時の簡易ログインボタン
  - [ ] fetchラッパで Authorization ヘッダの付与を集約
- [ ] フロント: ダッシュボードでアラート表示（初期はダミーデータorAPI連携）
  - [x] アラートカードコンポーネント（type/対象/日時/ステータス）
  - [ ] ダッシュボードで上位5件表示＋「すべて表示」リンク
- [ ] フロント: ウェルビーイング Not Good 時のタグ/短文と「ヘルプ/相談」モーダル導線実装（相談先候補・緊急案内表示）
  - [x] モーダルの固定テキスト（相談先候補3件、緊急案内）を配置
  - [x] Not Good選択時のみタグ/コメント入力欄を表示
- [x] 移行: 旧ID→新UUIDマッピングテーブル設計とサンプルスクリプト
  - [x] mapping_users, mapping_projects, mapping_vendors のDDLと例データ
  - [x] 移行後に参照切れを検出するクエリテンプレート
- [ ] 監査ログ設計: 主要操作（承認/発番/ウェルビーイング閲覧）のログ項目サマリ
  - [x] audit_logテーブル案（who/when/action/target/from/to/meta）
  - [x] 発番・承認・閲覧(Wellbeing)で記録する項目を列挙
- [ ] バックエンド: シンプルなバリデーション (zod / fastify schema) を主要エンドポイントに付与
  - [x] time/expense/estimate/invoice/PO/leave の schema で必須/型/最小値を整理
  - [x] バリデーション失敗時のエラーレスポンスを揃える
- [x] バックエンド: `/me` にロール/グループ等のモックデータを返す
  - [x] roleに応じたownerOrgId/projectsフィルタのモックを追加
- [ ] バックエンド: タイムシート修正時の承認ルール適用（変更時のみ approval 起動）
  - [ ] PATCH /time-entries/:id 追加、変更点判定でApprovalInstance作成スタブ
- [ ] バックエンド: 承認ステップの監査ログ（who/when/from/to/reason）保存
  - [ ] ApprovalStep更新時にaudit_logへINSERTするhookスタブ
- [ ] バックエンド: 送信Stub（請求書メール/発注書メール）とPDF生成枠のダミー関数
  - [x] services/notifier.ts に sendInvoiceEmail/sendPurchaseOrderEmail
  - [ ] services/notifier.ts に PDF生成スタブ（テンプレ名を受け取る）
- [ ] バックエンド: RBAC簡易チェック（role + projectId で閲覧をフィルタ）
  - [x] requireRoleにprojectIdチェックのオプションを追加し、time/expenseに適用
- [ ] フロント: APIクライアントの共通ラッパ（fetch + エラーハンドリング）
  - [x] ヘッダ付与・エラー時トースト表示・リトライなしのベーシック版
- [x] フロント: 請求ドラフト詳細画面モック（明細、承認状態、送信ボタン）
  - [x] ダミーデータで明細テーブルと承認ステータス表示
- [ ] フロント: 工数入力フォーム（プロジェクト/タスク/日付/時間/場所/残業区分）
  - [x] 入力→POST→一覧再取得のハッピーパス
- [ ] フロント: ヘルプモーダルの内容（相談先ラベル/説明/緊急案内）を表示
  - [x] 単体コンポーネント化して日報画面に組み込み
- [ ] テスト: バックエンド簡易ハッピーパス (contracts/invoices/time/expenses) のスモーク
  - [ ] supertest等で /projects→/estimates→/invoices→/send の一連
  - [ ] /time-entries, /expenses のPOST/GET
- [ ] テスト: フロントの手動確認手順（ダッシュボード→日報→工数→請求送信Stub）
  - [ ] READMEに手順と期待結果を書き出し
- [ ] CI: lint/format のジョブ追加 (GH Actions)、prisma format/validate を走らせる
  - [x] eslint/prettierが失敗した場合にfailさせる
- [ ] CI: Vite build テストのジョブ追加
  - [x] `npm run build --prefix packages/frontend` を既存ジョブとは別に明示
- [x] 移行: 抽出→変換→ロードのスクリプト雛形 (Python or SQL) を docs に追加
  - [x] 抽出SQLサンプル（プロジェクト/見積/請求/工数/経費）
  - [x] 変換スクリプト雛形（python/pandas or SQL）
  - [x] ロード手順と検証チェックリスト
- [x] 移行: 重複コード/欠損データの検出ルールと簡易レポート草案
  - [x] コード重複（project code/invoice no/po no）の検出SQL
  - [x] 欠損（工数のprojectId/userId無し、請求の金額0）の検出SQL

## 12/1 週（ステージング前の仕上げ）
- [ ] 発番と承認の実装PoC（API + バッチジョブで連携）
- [ ] アラート発火の最小実装（予算+10%、残業、承認遅延のダッシュボード表示＋メール送信Stub）
- [ ] 定期案件テンプレ生成のジョブテスト（毎月/四半期）
- [ ] ウェルビーイング入力と人事閲覧のRBAC/監査ログ実装PoC
- [ ] レポート3種の算出ロジック（プロジェクト別工数/予実、グループ別工数、個人別残業）
- [ ] 納期範囲の未請求レポート（マイルストーンと請求の紐付け確認）
- [ ] フロント: 日報/工数入力のUX改善とバリデーション（モバイル対応）
- [ ] フロント: 請求ドラフトの一覧/詳細で番号・ステータスを表示、送信Stub連携
- [ ] バックエンド: PDF生成Stub（請求書/発注書）とテンプレAPIの枠
- [ ] バックエンド: 休暇/経費/タイムシート修正承認の統一ハンドラ
- [ ] QA: 簡易E2Eまたは手順書（ハッピーパス）
- [ ] フロント: 人事向け匿名集計ビューの骨組み（5人未満非表示）※簡易でもよい
- [ ] バックエンド: metrics計算関数のスタブ（予算消化率、残業時間、承認遅延計測）
- [ ] バックエンド: AlertSettingのCRUDと有効/無効切替API
- [ ] バックエンド: ApprovalRule CRUDと条件/ステップ保存
- [ ] バックエンド: RateCard 適用ロジック（工数×単価計算の枠）
- [ ] フロント: アラート設定と承認ルールの簡易設定画面モック（保存は後続でも可）
- [ ] 移行: サンプルデータを使ったPoCロード＆整合チェック（工数件数、請求合計）
- [ ] CI: prettier/eslint 設定と整合性チェック
- [ ] セキュリティ: CORS/ヘッダ/基本的な入力サイズ制限設定
- [ ] プロダクト: アラート再送/サプレッションの設計メモ追加
- [ ] プロダクト: QA用シードデータセット（プロジェクト/見積/請求/工数/経費）の作成

## 12/10 以降（MVP後続拡張）
- [ ] 承認期限エスカレーション、Slack/Webhook外部通知
- [ ] 経費UI高度化（領収書アップロード/リマインダ）
- [ ] グループチャット（プロジェクト紐付け、タグ、絵文字）
- [ ] スマホネイティブアプリ検討（Web API/BFF再利用）
- [ ] レポート拡充（カスタムレイアウト、CSV/PDFエクスポートの柔軟化）
- [ ] データ品質チェックバッチ（コード重複、参照切れ、税率不整合）
- [ ] 認証/IDaaS連携強化（Google/AD連携、SCIMなど）
- [ ] PDF/メール本実装（テンプレ管理、署名/ロゴ、送信結果トラッキング）
- [ ] アラートのリマインド/サプレッション設定
- [ ] 承認期限エスカレーション設定UIとバッチ
- [ ] ウェルビーイング匿名集計の高度化（時系列/部門比較、フィルタ、閾値設定）
- [ ] モバイル/ネイティブApp対応（オフライン入力、Push通知）
- [ ] 見積/請求テンプレ管理UI（番号ルール、フォーマット、署名挿入）
- [ ] テーブル設計の正規化/性能チューニング（大規模データに向けた再設計）
