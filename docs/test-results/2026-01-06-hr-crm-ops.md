# HR/CRM 連携 運用検証（2026-01-06）

## 目的
- 手動/定期実行、差分同期、失敗/リトライ、アラートの挙動を確認する。

## 環境
- Podman: `scripts/podman-poc.sh reset`
- Backend: `node packages/backend/dist/index.js`
- ENV: `AUTH_MODE=header`, `MAIL_TRANSPORT=stub`

## 実施内容と結果
### 1. 連携設定の作成
- AlertSetting(integration_failure): `7cbb8e5c-34b7-4cd6-8a3f-80b931bff021`
- CRM setting: `60a7b82e-5c43-4bab-a2bc-821d07d86aec`（schedule=`0 2 * * *`）
- HR setting: `361e4cfb-be98-4624-b0d3-5270b564d243`（schedule=`0 3 * * *`）

### 2. 手動実行
- CRM run: `8188813d-1a98-42b9-a7ca-a056290b13bc`（message=exported, metrics=customers:1 vendors:1 contacts:0）
- HR run: `7ad7518c-097c-4983-a6ba-781b853e0f80`（message=exported, metrics=users:0 wellbeing:0）

### 3. 差分同期（updatedSince）
- CRM config に `updatedSince=2026-01-06T00:00:00Z` を設定
- CRM delta run: `5713e01b-45e5-4395-94de-09a0aff4c34a`（message=exported_delta, metrics=customers:1 vendors:1 contacts:0）

### 4. 定期実行ジョブ
- `/jobs/integrations/run` → scheduledCount=2 を確認

### 5. 失敗/アラート
- CRM config に `simulateFailure=true` を設定して実行
- run `79fb404b-815b-4187-941d-ec027cc62edc` が `status=failed` / message=simulate_failure
- Alert `afac4f46-92c2-44d1-94bd-03d251cdcae7` が作成され、sentChannels に email(stub) を確認

### 6. リトライ
- `nextRetryAt` を現在時刻へ更新後、`/jobs/integrations/run` を実行
- retryCount=1 の再送が `status=success` になったことを確認
- `/alerts?status=open` が空（アラートが閉じられたことを確認）

### 7. データ品質チェック（HR/CRM）
- customer_externalid_missing = 1
- vendor_externalid_missing = 1
- contact_orphan = 0
- user_externalid_missing = 0
- wellbeing_missing_fields = 0

## 補足
- seed データに externalId が未設定のため、CRM の externalId 欠損が検出。
