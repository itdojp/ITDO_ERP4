# Definition of Done（DoD）

## 目的
PR（変更単位）で「完了」と見なす条件を定義し、レビュー基準を固定化する。

## DoD（全PR共通）
- 目的/背景が PR 本文に記載されている（Issueリンクを含む）
- 変更範囲が PR 本文で説明されている（影響範囲/非ゴール）
- 破壊的変更（API/DB/挙動）がある場合は、移行手順または互換方針が明記されている
- 監査ログ/権限制御/入力バリデーションに関わる変更は、想定される誤用ケースを確認している
- `docs/quality/quality-gates.md` の必須ゲートが通る

## テストに関するDoD
- 変更に対応するテストが存在する（追加/更新）ことが望ましい
  - 例: 重要なフローは E2E（`scripts/e2e-frontend.sh`）かスモーク（`scripts/smoke-backend.sh`）
- テストを追加できない/しない場合は、PR本文に理由と代替（手動QA手順/検証ログ/証跡）を記載する
- 手動検証を行った場合は、必要に応じて `docs/test-results/` へ記録する（後で比較できる形）

## docsのみ変更のDoD
- リンク切れがない（`Link Check / lychee` が通る）
- 実装との乖離がない（根拠となるファイルパス/コマンドを併記する）
- 運用手順は「誰が見ても同じ結果になる」粒度で書く（環境変数/前提/失敗時の対処）

## DBスキーマ変更のDoD
- Prisma schema の整合性が保たれている（`prisma validate`）
- 既存データへの影響（NOT NULL追加、enum変更、unique追加等）を記載している
- ロールバック方針が説明されている（原則: DBバックアップから復元）
- PoC/検証で最低限の整合チェック（`scripts/checks/poc-integrity.sql`）を確認している

## セキュリティ関連変更のDoD
- 想定する脅威と対策をPR本文に記載する（例: SSRF/権限昇格/情報漏えい）
- 「デフォルト安全」を優先する（例: 外部送信は allowlist、スキャナ停止時は fail closed 等）
- シークレット/トークンをリポジトリにコミットしない（例: `.env`、鍵、認証情報）

