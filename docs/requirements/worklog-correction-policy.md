# 日報/工数の訂正・確定ポリシー（設計）

## 目的

- 旧システムで担保していた「日々の業務記録」を、メールを介さず **UIで完結**する形で再設計する。
- 損益/予実/監査の観点で「後から数字が揺れる」ことを抑止するため、**訂正可能期間**と**権限**を明文化する。

## 背景

- 工数（TimeEntry）は損益・請求・予実に直結するため、無制限の修正は避けたい。
- 日報本文（DailyReport.content）は損益に直接影響しないが、監査上は履歴の保持が望ましい。

## 用語

- `workDate`: 工数（TimeEntry）の実績日（`YYYY-MM-DD`）。
- `reportDate`: 日報（DailyReport）の対象日（`YYYY-MM-DD`）。
- 「遡及可能期間（N日）」: `workDate/reportDate` を基準に、一般ユーザが訂正できる期間。
- 「closed ロック」: 対象プロジェクトが `closed` の場合に、工数の訂正を制限すること。

## 決定事項（このドキュメントの前提）

- 遡及可能期間の基準日は **`workDate/reportDate` 基準**（提出日基準ではない）。
- 遡及可能期間（N日）の初期値は **14日**。
- 日報本文（テキスト）は **履歴保存**を行う。
- 日報本文のロックは **プロジェクト `closed` では行わない**（工数の指定/日付基準に合わせる）。
- 日報本文の「修正不可」は **admin/mgmt は例外的に修正可**。
- プロジェクト `closed` によるロックは **工数（TimeEntry）のみ**に適用する（経費等へは本ポリシーでは拡張しない）。

## ポリシー仕様

### 1) 工数（TimeEntry）

#### 1-1. 訂正可否

- 一般ユーザ（`user`）が訂正できる条件:
  - `today <= workDate + 14日` であること
  - かつ、対象 `project.status != closed` であること
- 上記条件を満たさない場合:
  - **admin/mgmt のみ**訂正可能
  - 訂正時は **理由（reasonText）必須** + **監査ログ必須**（監査ログは既存基盤に記録）

#### 1-2. 対象操作

- 既存の工数修正（`PATCH /time-entries/:id`）および工数付け替え（`POST /time-entries/:id/reassign`）に適用する。
- 既存仕様（重要項目の変更時は承認フローに入る）は維持する。

#### 1-3. UI表現

- 訂正不可の場合、入力UIを無効化し、理由を明示する（例: 「実績日から14日を過ぎています」「案件が完了（closed）です」）。
- admin/mgmt で訂正する場合は理由入力欄を表示する。

### 2) 日報本文（DailyReport）

#### 2-1. 訂正可否

- 一般ユーザ（`user`）が訂正できる条件:
  - `today <= reportDate + 14日` であること
- 上記条件を満たさない場合:
  - **admin/mgmt のみ**訂正可能
  - 訂正時は **理由（reasonText）必須** + **監査ログ必須**

> 注: 日報本文はプロジェクト `closed` によるロックを行わない。

#### 2-2. 履歴（改ざん抑止と監査）

- 日報本文は更新のたびにリビジョンを保存する（差分ではなく全文保存）。
- 最低限の保持項目:
  - `dailyReportId`, `version`, `content`, `linkedProjectIds`, `updatedAt`, `updatedBy`, `reasonText(任意/必須は運用決定)`
- 監査ログ（AuditLog）にも `daily_report_updated` を記録する。

#### 2-3. 日単位の一意性

- UIを「1日=1画面」にするため、日報は `userId + reportDate(YYYY-MM-DD)` の **日単位 upsert** を前提とする。
- 既存の `DailyReport.reportDate` は DateTime のため、`@db.Date`（DATE）へ寄せ、API入力は `YYYY-MM-DD` を必須にする。
  - 目的: タイムゾーン/時刻で同日が複数行になる事故を避ける。

### 3) 設定値（14日）

- 「遡及可能期間（14日）」は運用で変更できるようにする（システム設定）。
- 実装案:
  - `WorklogSetting(id='default')` を追加し `editableDays` を保持
  - 管理画面（Settings）から変更可能にする

## 非スコープ（別途検討）

- 経費（Expense）への同等の遡及/closed ロック適用（損益への影響はあるが、本決定では対象外）
- 期間締め（PeriodLock）との統合（より強い確定だが、本決定では未統合）
- ウェルビーイング（WellbeingEntry）の訂正可否ポリシー（別ドキュメントで整理）

