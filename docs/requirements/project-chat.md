# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒ£ãƒƒãƒˆä»•æ§˜ï¼ˆçµ±åˆï¼‰

## ç›®çš„/ã‚¹ã‚³ãƒ¼ãƒ—
- ERPã¨çµ±åˆã•ã‚ŒãŸãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã¨ã—ã¦ã€Slack/Chatworkä»£æ›¿ã‚’ç›®æŒ‡ã™
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±/ã‚¿ã‚¹ã‚¯/æ‰¿èªãªã©ERPã®æƒ…å ±ã¨é€£å‹•ã—ãŸåˆ©ç”¨ã‚’æƒ³å®šã™ã‚‹
- AIã‚’å–ã‚Šè¾¼ã¿ã€è¦ç´„/ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æŠ½å‡ºãªã©ã®æ”¯æ´ã‚’è¡Œã†ï¼ˆè©³ç´°ã¯æ±ºå®šå¾…ã¡ï¼‰

## ç¾çŠ¶ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå˜ä½ã®ç°¡æ˜“ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆ
- æŠ•ç¨¿/é–²è¦§/ã‚¿ã‚°/ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³/ãƒšãƒ¼ã‚¸ãƒ³ã‚°ã®ã¿
- ç›£æŸ»/é€šçŸ¥/ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é…ä¿¡/æ·»ä»˜/æ¤œç´¢ã¯æœªå®Ÿè£…

## å½¹å‰²/ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
- è¨±å¯ãƒ­ãƒ¼ãƒ«: admin / mgmt / user / hr / exec / external_chat
- admin/mgmt ã¯å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- ãã‚Œä»¥å¤–ã®ãƒ­ãƒ¼ãƒ«ã¯ `projectIds` ã«å«ã¾ã‚Œã‚‹æ¡ˆä»¶ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- `external_chat` ã¯ãƒãƒ£ãƒƒãƒˆã®ã¿åˆ©ç”¨å¯ï¼ˆä»–æ©Ÿèƒ½ã¯ä¸å¯ï¼‰

## æ±ºå®šäº‹é …ï¼ˆè¦‹ç›´ã—åæ˜ ï¼‰
- æœªèª­/æ—¢èª­çŠ¶æ…‹ã‚’ä¿æŒã™ã‚‹
- æ—¢èª­çŠ¶æ…‹ã‚’ä»–ã®ãƒ¦ãƒ¼ã‚¶ã«è¦‹ã›ã‚‹ã‹ã¯ã€Œãƒãƒ£ãƒƒãƒˆå˜ä½ã€ã§ç®¡ç†è€…ãŒé¸æŠå¯èƒ½
- ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã¯å¿…é ˆ
- æœ¬æ–‡ã¯Markdownã§è¨˜è¿°ã™ã‚‹
- é€šçŸ¥/æ·»ä»˜/æ¤œç´¢ã¯ERPçµ±åˆã¨ã—ã¦æœ›ã¾ã—ã„å½¢ã§è¨­è¨ˆã™ã‚‹ï¼ˆæ–¹å¼ã¯æœªæ±ºå®šï¼‰

## æœªæ±ºå®š/è¦è¨­è¨ˆ
- ãƒãƒ£ãƒƒãƒˆå˜ä½ã®å®šç¾©ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé™å®šã‹ã€éƒ¨é–€/å…¨ç¤¾/DMã‚’å«ã‚ã‚‹ã‹ï¼‰
- æ—¢èª­è¡¨ç¤ºã®ç²’åº¦ï¼ˆæ—¢èª­è€…ä¸€è¦§/äººæ•°ã®ã¿/éè¡¨ç¤ºï¼‰
- ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã®ç¨®é¡ï¼ˆãƒ¦ãƒ¼ã‚¶/ãƒ­ãƒ¼ãƒ«/ã‚°ãƒ«ãƒ¼ãƒ—/ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼‰
- Markdownæ–¹è¨€ï¼ˆCommonMark/GFMãªã©ï¼‰ã¨ã‚µãƒ‹ã‚¿ã‚¤ã‚ºæ–¹é‡
- æ·»ä»˜ã®ä¿å­˜å…ˆ/æ¨©é™åˆ¶å¾¡/å®¹é‡ä¸Šé™/ã‚¦ã‚¤ãƒ«ã‚¹ã‚¹ã‚­ãƒ£ãƒ³
- æ¤œç´¢ã®å¯¾è±¡ç¯„å›²ï¼ˆãƒãƒ£ãƒƒãƒˆã®ã¿/ERPæ¨ªæ–­/æ·»ä»˜å«ã‚€ï¼‰
- é€šçŸ¥ãƒãƒ£ãƒãƒ«ï¼ˆã‚¢ãƒ—ãƒªå†…/ãƒ¡ãƒ¼ãƒ«/Push/å¤–éƒ¨é€£æºï¼‰ã¨é€šçŸ¥æ¡ä»¶
- AIæ©Ÿèƒ½ã®ç¯„å›²ï¼ˆè¦ç´„/ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æŠ½å‡º/FAQ/æ¤œç´¢æ”¯æ´ãªã©ï¼‰ã¨æ¨©é™/ç›£æŸ»
- å¤–éƒ¨ãƒ¦ãƒ¼ã‚¶ï¼ˆexternal_chatï¼‰ã®å‚åŠ ç¯„å›²/åˆ¶é™

## ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
### ProjectChatMessage
- `id`: UUID
- `projectId`: å‚ç…§å…ˆ `Project`
- `userId`: æŠ•ç¨¿è€…ã®ID
- `body`: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡
- `tags`: JSONé…åˆ—ï¼ˆæ–‡å­—åˆ—ã®ã‚¿ã‚°ä¸€è¦§ï¼‰
- `reactions`: JSONãƒãƒƒãƒ—ï¼ˆemoji -> { count, userIds[] }ï¼‰
- `createdAt/createdBy`, `updatedAt/updatedBy`
- `deletedAt/deletedReason`ï¼ˆè«–ç†å‰Šé™¤ç”¨ã€APIæœªå®Ÿè£…ï¼‰

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- `projectId, createdAt`

## ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ï¼ˆæ‹¡å¼µæ¡ˆï¼‰
- ChatRoomï¼ˆtype, name, projectId?, readReceiptMode, createdBy ãªã©ï¼‰
- ChatRoomMemberï¼ˆroomId, userId, role, lastReadAt ãªã©ï¼‰
- ChatMessageï¼ˆroomId, userId, bodyMarkdown, createdAt ãªã©ï¼‰
- ChatMessageReadï¼ˆmessageId, userId, readAtï¼‰â€»æ—¢èª­è¡¨ç¤ºã®ç²’åº¦æ¬¡ç¬¬
- ChatAttachmentï¼ˆmessageId, storageKey, fileName, mime, size ãªã©ï¼‰
- ChatMentionï¼ˆmessageId, targetUserId/targetGroupId ãªã©ï¼‰

## API
### ç¾è¡ŒAPI
### GET `/projects/:projectId/chat-messages`
**Query**
- `limit` (default 50, max 200)
- `before` (ISOæ—¥æ™‚ã€‚ã“ã‚Œä»¥å‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—)
- `tag` (ä»»æ„ã€‚ã‚¿ã‚°ãŒä¸€è‡´ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿)

**æŒ™å‹•**
- `createdAt` é™é †ã§å–å¾—
- `tag` ã¯ãƒˆãƒªãƒ å¾Œã®å®Œå…¨ä¸€è‡´ã§ãƒ•ã‚£ãƒ«ã‚¿
- `tag` ãŒç©º/æœªæŒ‡å®šã®å ´åˆã¯ãƒ•ã‚£ãƒ«ã‚¿ãªã—

**ã‚¨ãƒ©ãƒ¼**
- `limit` ãŒæ­£æ•°ã§ãªã„å ´åˆã¯ 400
- `before` ãŒä¸æ­£ãªæ—¥ä»˜ã®å ´åˆã¯ 400
- `tag` ãŒ 32 æ–‡å­—è¶…ã®å ´åˆã¯ 400

### POST `/projects/:projectId/chat-messages`
**Body**
- `body` (1ã€œ2000æ–‡å­—)
- `tags` (ä»»æ„: 0ã€œ8ä»¶ã€å„32æ–‡å­—ã¾ã§)

**æŒ™å‹•**
- `userId` ã¯èªè¨¼æƒ…å ±ã‹ã‚‰å–å¾—
- èªè¨¼æƒ…å ±ãŒä¸è¶³ã™ã‚‹å ´åˆã¯ `demo-user` ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆPoCå‘ã‘ï¼‰
  - æœ¬ç•ªç’°å¢ƒã§ã¯ç„¡åŠ¹åŒ–ã—ã€401/403 ã‚’è¿”ã™å‰æ
  - `demo-user` ã¯æ˜ç¤ºçš„ãªè¨­å®šãƒ•ãƒ©ã‚°ã§ã®ã¿æœ‰åŠ¹åŒ–ã™ã‚‹

### POST `/chat-messages/:id/reactions`
**Body**
- `emoji` (1ã€œ16æ–‡å­—)

**æŒ™å‹•**
- åŒä¸€ãƒ¦ãƒ¼ã‚¶ã®åŒä¸€emojiã¯1å›ã®ã¿åŠ ç®—
- å½¢å¼ã¯ `{ emoji: { count, userIds[] } }`
- æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒæ•°å€¤ã®å ´åˆã¯äº’æ›æ‰±ã„ã§æ›´æ–°ã™ã‚‹

### æ‹¡å¼µAPIï¼ˆæ¡ˆï¼‰
- `GET /chat-rooms`ï¼ˆå‚åŠ å¯èƒ½ãªãƒãƒ£ãƒƒãƒˆä¸€è¦§ï¼‰
- `POST /chat-rooms`ï¼ˆæ–°è¦ä½œæˆ/è¨­å®šï¼‰
- `GET /chat-rooms/:id/messages`ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—ï¼‰
- `POST /chat-rooms/:id/messages`ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æŠ•ç¨¿ï¼‰
- `POST /chat-rooms/:id/read`ï¼ˆæ—¢èª­æ›´æ–°ï¼‰
- `GET /chat-rooms/:id/unread-counts`ï¼ˆæœªèª­ä»¶æ•°ï¼‰
- `POST /chat-messages/:id/attachments`ï¼ˆæ·»ä»˜ï¼‰
- `GET /chat-search?q=`ï¼ˆæ¤œç´¢ï¼‰

## UIï¼ˆProjectChatï¼‰
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠã€èª­ã¿è¾¼ã¿ã€æŠ•ç¨¿ã€ã‚¿ã‚°è¡¨ç¤ºã€ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
- ã‚¿ã‚°çµã‚Šè¾¼ã¿å…¥åŠ›ï¼ˆé©ç”¨ã¯ã€Œèª­ã¿è¾¼ã¿ã€ãƒœã‚¿ãƒ³ï¼‰
- è¿½åŠ èª­ã¿è¾¼ã¿ï¼ˆ`before` ä½¿ç”¨ï¼‰
- æ—¢å®šã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³å€™è£œ: ğŸ‘/ğŸ‰/â¤ï¸/ğŸ˜‚/ğŸ™/ğŸ‘€

## UIï¼ˆæ‹¡å¼µæ–¹é‡ï¼‰
- æœªèª­/æ—¢èª­è¡¨ç¤ºï¼ˆè¨­å®šã«å¿œã˜ã¦è¡¨ç¤ºæ–¹å¼ã‚’åˆ‡æ›¿ï¼‰
- ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å…¥åŠ›æ”¯æ´
- Markdownãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
- æ·»ä»˜/æ¤œç´¢/é€šçŸ¥è¨­å®šã®å°ç·š
- AIæ”¯æ´ï¼ˆè¦ç´„/ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æŠ½å‡ºï¼‰è¡¨ç¤ºã®å°ç·š

## ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³/åˆ¶ç´„
- æœ¬æ–‡: 1ã€œ2000æ–‡å­—
- ã‚¿ã‚°: æœ€å¤§8ä»¶ã€å„32æ–‡å­—
- ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³emoji: 1ã€œ16æ–‡å­—

## ãƒ†ã‚¹ãƒˆ
- E2Eã‚¹ãƒ¢ãƒ¼ã‚¯ã«ã€ŒæŠ•ç¨¿/ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€å«ã‚€
  - `packages/frontend/e2e/frontend-smoke.spec.ts`

## æœªå®Ÿè£…/å¾Œç¶šã‚¹ã‚³ãƒ¼ãƒ—
- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç·¨é›†/å‰Šé™¤ï¼ˆè«–ç†å‰Šé™¤APIï¼‰
- ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å–ã‚Šæ¶ˆã—ï¼ˆãƒˆã‚°ãƒ«ï¼‰
- æ·»ä»˜/ç”»åƒ/ãƒ•ã‚¡ã‚¤ãƒ«
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼ˆWS/ãƒãƒ¼ãƒªãƒ³ã‚°ï¼‰
- ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³/é€šçŸ¥é€£æº
- æ—¢èª­/æœªèª­ã®è¡¨ç¤º/è¨­å®š
- è¤‡æ•°ã‚¿ã‚°ã® AND/OR æ¤œç´¢

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- `docs/requirements/data-model-sketch.md`
- `docs/requirements/domain-api-draft.md`
- `docs/requirements/frontend-api-wire.md`
- `docs/requirements/rbac-matrix.md`
- `docs/requirements/access-control.md`
