# 運用監視（最小設計案）

## 目的
- バッチ失敗やアラート遅延を早期に検知する。
- 本番運用の最小監視観点を定義する。

## 監視対象（優先順）
1. **バッチ/ジョブ**
   - 発番/定期案件/アラート計算/承認エスカレーション
   - 失敗件数、最終実行時刻、連続失敗回数
2. **アラート/通知**
   - アラート遅延（triggeredAt → sent）
   - 送信失敗（document_send_logs / mail logs）
3. **API/DB 基盤**
   - API 5xx 率、遅延、DB 接続数、遅いクエリ

## 監視指標（例）
- ジョブ失敗: 1回でも失敗 → 通知
- アラート遅延: 24h 超過は要確認（管理画面閾値に合わせる）
- 送信失敗率: 一定回数連続失敗で通知

## 閾値の初期案（ドラフト）
- ジョブ失敗: 1回で警告、3回連続で重要アラート
- アラート遅延: 24h 超過で警告、48h 超過で重要
- 送信失敗: 3回連続失敗で警告、5回連続失敗で重要
- いずれも管理画面で変更可能にする前提

## 再送ポリシー（案）
- 送信失敗時は最大3回まで再送（指数バックオフ）
- 再送間隔: 5分 → 15分 → 45分
- それでも失敗した場合は手動対応（管理部ダッシュボードに表示）

## 通知チャネル
- 既定: 管理者へのメール + 管理ダッシュボード
- 将来: Slack/Webhook 連携

## 最低限の運用手順
- 日次: 失敗ジョブ数/アラート遅延件数の確認
- 週次: 送信失敗の再送状況確認

## TODO
- 監視の閾値を管理画面で設定できるようにする（叩き台は追記済み）
- 送信失敗の再送ポリシー（回数/間隔）を明文化（叩き台は追記済み）
