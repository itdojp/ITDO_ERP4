# 運用監視（最小設計案）

## 目的
- バッチ失敗やアラート遅延を早期に検知する。
- 本番運用の最小監視観点を定義する。

## 監視対象（優先順）
1. **バッチ/ジョブ**
   - 発番/定期案件/アラート計算/承認エスカレーション
   - レポート購読/配信（report_subscriptions / report_deliveries）
   - 外部連携（HR/CRM）の同期ジョブ
   - 失敗件数、最終実行時刻、連続失敗回数
2. **アラート/通知**
   - アラート遅延（triggeredAt → sent）
   - 送信失敗（document_send_logs / report_deliveries / mail logs）
3. **API/DB 基盤**
   - API 5xx 率、遅延、DB 接続数、遅いクエリ

## 監視指標（例）
- ジョブ失敗: 1回でも失敗 → 通知
- アラート遅延: 24h 超過は要確認（管理画面閾値に合わせる）
- 送信失敗率: 一定回数連続失敗で通知
- レポート配信: failed/failed_permanent 件数、retry待ち件数、最終配信時刻
- 外部連携失敗: integration_failure の AlertSetting で通知

## 閾値の初期案（ドラフト）
- ジョブ失敗: 1回で警告、3回連続で重要アラート
- アラート遅延: 24h 超過で警告、48h 超過で重要
- 送信失敗: 3回連続失敗で警告、5回連続失敗で重要
- いずれも管理画面で変更可能にする前提

## 再送ポリシー（運用）
- 未対応のアラートに対して、`remindAfterHours`（時間）間隔でリマインド送信（初回通知に加えて、最大 `remindMaxCount` 回のリマインド送信）
- 再送間隔は `remindAfterHours` で一定（段階式は将来拡張）
- `remindAfterHours` が未設定の場合は再送なし
- デフォルト: `remindMaxCount=3`（初回通知 + 最大3回のリマインド = 最大4回の通知）

## 通知チャネル
- 既定: 管理者へのメール + 管理ダッシュボード
- 将来: Slack/Webhook 連携

## 最低限の運用手順
- 日次: 失敗ジョブ数/アラート遅延件数の確認
- 日次: レポート配信の failed_permanent / retry待ち件数の確認
- 週次: 送信失敗の再送状況確認

## TODO
- [x] 監視の閾値を管理画面で設定できるようにする（AlertSettingで対応）
- [x] 送信失敗の再送ポリシー（回数/間隔）を明文化
