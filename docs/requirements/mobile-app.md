# モバイル/ネイティブ対応方針（案）

## 目的
- 日報/工数の入力をスマホから快適に行えるようにする。
- 承認/アラート/リマインドを Push で通知する。

## 対象スコープ（想定）
- 日報/ウェルビーイング入力
- 工数入力（案件/タスク/時間/残業区分）
- 経費入力
- 承認待ち/アラートの通知と簡易確認

## 端末/OS
- iOS / Android を対象（法人利用想定）。
- PoC は PWA またはラッパー（Capacitor）で開始。

## オフライン同期
- 端末側で下書きを保存（IndexedDB/SQLite）。
- 送信待ちキューを持ち、再接続時に同期。
- 衝突は「新しい更新優先」を基本に、差分レビューを残す。

## Push 通知
- 種別: 承認待ち/アラート/日報リマインド。
- 基盤: APNS/FCM を想定。
- 通知は最小限の情報で表示し、詳細はアプリ内で確認。

## API/BFF 再利用
- 既存 REST API を再利用。
- モバイル向けの BFF を用意し、バッテリー/通信量を最適化。

## 実装フェーズ
1. **PWA PoC**: レスポンシブ UI + オフライン下書き。
2. **ラッパーアプリ**: Push通知と端末機能（撮影アップロード）。
3. **ネイティブ本実装**: 高度なUXとオフライン同期の最適化。

## PoC 設計（#157）
### 方針案
- 初期は **PWA** を第一候補とし、必要なら **Capacitor** でラップ。
- 対象フローは日報/工数/経費の「入力→送信」最小セット。

### オフライン下書き
- IndexedDB で下書きを保持。
- 送信キューを持ち、再接続時に自動再送。
- 同期衝突は「新しい更新優先」。

### Push 通知（MVP）
- 承認待ち/アラート/日報リマインド。
- APNS/FCM は後続、PoC は疑似通知（ダッシュボード表示）。

### API/BFF 影響
- モバイル向けにレスポンスを軽量化する BFF を検討。
- ファイルアップロードの経路（領収書/添付）を整理。

### オープン事項
- 端末ストレージの暗号化方針。
- 通知の文面/個人情報の扱い。

## PWA Push 検証手順（PoC）
1. `.env` に `VITE_PUSH_PUBLIC_KEY` を設定（VAPID公開鍵）。開発でSWを有効にする場合は `VITE_ENABLE_SW=true`。
2. ログイン後、ユーザー欄の「Push通知」から「購読登録」を押下。
3. 「テスト通知」を押下し、通知が表示されることを確認。
4. 通知クリックで `/` に遷移できることを確認。

## 運用検証（Phase 2）
### オフラインキュー
- 機内モードで日報/工数/経費を送信 → キューに保存されることを確認。
- オンライン復帰で自動送信され、二重送信が起きないことを確認。
- 送信失敗時に再試行されること（再接続/再読込で消えないこと）を確認。

### 競合/重複
- 同じ対象を複数端末で更新し、最新更新優先になることを確認。
- 送信順序（TimeEntry/Expense/日報）が逆転しても破綻しないことを確認。

### Push 同意/解除
- 購読解除で通知が来ないこと、再登録で復帰することを確認。
- ブラウザ再起動/再ログイン後の購読状態が維持されることを確認。

### Service Worker 更新/キャッシュ
- Service Worker 更新後に最新の画面/リソースへ更新されることを確認。
- キャッシュ破棄後も最低限の画面が表示できることを確認。

### 失敗時ログ/通知
- Push 送信失敗や購読失敗時にユーザーへ通知/説明が出ることを確認。
- 失敗理由がログで追えること（管理画面または開発ログ）を確認。

### 記録
- 実施日/端末/OS/ブラウザ/結果/問題を残す（Issueに貼り付け）。
