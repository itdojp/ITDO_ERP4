# 発注書→仕入請求（VendorInvoice）連動設計（MVP確定）

## 背景
旧システムでは発注書から業者請求書（仕入請求）を作成する運用があり、参照/紐付けが前提でした。ERP4では PurchaseOrder / VendorQuote / VendorInvoice は存在するものの連動方針が未確定です。

## 現状（ERP4）
- PurchaseOrder / VendorQuote / VendorInvoice の CRUD と承認が存在
- `VendorInvoice.purchaseOrderId`（任意）により、PO→VI の 1対多（PO:1 → VI:n、VI→PO は 0..1）を表現可能

## 差分/課題
- UI導線（PO から VI 作成/参照）が不足
- 仕入側の承認/編集ロック、差戻し時の扱いが未整理

## MVP方針
- 関連付け: 1対多（PO→複数VI）を前提にし、多対1（複数PO→1VI）は後続で要件確認
- POリンク: 作成時の紐づけに加え、既存仕入請求（VI）の紐づけ変更/解除を可能にする
- 制約（POリンク変更/解除の許容範囲）:
  - `received` / `draft` / `rejected`: 通常運用で変更/解除可
  - `pending_qa` 以降: admin/mgmt のみ（理由必須 + 監査）
  - `paid`: 原則禁止。ただし例外時は admin/mgmt + 理由必須 + 監査で許可
- 明細対応: MVPは「参照のみ」（明細レベルの厳密整合は後続）

## 追加で整理すべき論点（未確定）
### 差戻し時の扱い
- 差戻し（`rejected`）時は POリンクの維持/変更を通常運用で許容する（MVP確定）

### 状態遷移（案）
- PurchaseOrder: `draft` → `pending_qa` → `pending_exec` → `approved` → `sent` / `acknowledged`
- VendorQuote: `received` → `approved` / `rejected`（現状の運用想定）
- VendorInvoice: `received` → `pending_qa` → `pending_exec` → `approved` → `paid`（`rejected`/`cancelled` あり）

### UI導線（案）
- PO詳細から「仕入請求作成」ボタン（POを引用して VI を作成）
- PO詳細に「リンク済み仕入請求（VI）一覧」を表示
- VI詳細に「関連PO」セクションを表示し、変更/解除を可能にする（制約: `pending_qa` 以降は admin/mgmt のみ）
- 仕入請求の支払確認は admin/mgmt 操作

### 監査/通知（案）
- 発注/請求の発行・承認・支払確定を監査ログへ
- 支払完了の通知は申請者/担当者へ（チャネルは運用次第）

## TODO
- [x] MVP: 1対多リンク（PO→複数VI、VI→POは0..1）を採用
- [x] POリンクの変更/解除の権限・監査（admin/mgmt 区別、理由必須など）を確定
- [x] 差戻し時のリンク維持/変更可否を確定
- [ ] 明細レベルの対応方針（参照/警告/厳密）を確定
- [ ] 多対1対応の要否を判断（後続）

## 後続（MVP外）: #768 明細レベル整合（PO明細↔VI明細）

### 決定事項（#768）
- VI明細は必須ではない（元の書類添付で代替可能）
- 1つのVIが複数案件に分割されうる。分割する場合は配賦明細（分割可能な明細）が必要
- 税計算は税率別を前提にする。配賦/按分時の端数はシステムで自動調整し、不可時は理由付きでエスカレーション

### 現状の制約
- PO には `PurchaseOrderLine` があるが、VI には明細テーブルがない（現状は合計 `totalAmount` 中心）
- そのため「PO明細↔VI明細の厳密整合」を行う場合、VI明細のデータモデル追加が必要
- PO番号の記載はほぼ無く、照合キーとしては期待できない

### 段階的導入案（推奨）
- Phase 0: 参照のみ
  - VI 詳細に「リンク先 PO の明細」を read-only で表示
  - 合計金額（PO total / VI total）に差分がある場合は注意喚起（警告表示のみ、ブロックしない）
- Phase 1: 明細選択（参照スコープの明確化）
  - VI に「対象 PO 明細（選択）」または配賦明細を保持し、どの PO 明細がこの VI に対応する想定かを明示できるようにする
  - 整合は警告ベース（数量/単価/税率/金額の厳密チェックは後続）
  - 配賦明細が必要な場合の最小項目は `projectId / amount / taxRate / taxAmount` を想定（数量/単価は任意）
- Phase 2: 厳密整合（必要になった場合のみ）
  - 数量/金額の割当（部分請求・分割請求）まで含めるかを要件化した上で導入
  - status/権限/差戻し（rejected）の扱いと、監査ログ/履歴表示の粒度を確定する
  - 税率別合計に合わせた按分/端数調整ロジックを含める（税計算は税率別が前提）

### データモデル案（例）
- 案A: `VendorInvoiceLine` を追加し、`purchaseOrderLineId`（任意）で紐付け（VI明細↔PO明細）
  - 長所: UI/監査で説明しやすい（VI側に明細が存在）
  - 短所: 運用入力が増える（請求書PDFからの転記が必要）
- 案B: `VendorInvoice` と `PurchaseOrderLine` の中間テーブルで「参照対象の PO 明細」を保持（VI明細は持たない）
  - 長所: 最小の入力で「どの PO 明細か」を表現できる
  - 短所: VI明細そのものの比較（差分表示/厳密整合）には拡張が必要
- 案C: 配賦明細（案件/税率別）を持ち、PO明細は参照リンクのみ
  - 長所: 複数案件への分割と税率別計算に対応しやすい
  - 短所: PO明細との1:1対応は弱くなる

## 後続（MVP外）: #769 多対1（複数PO→1VI）の要否判断

### 判断が必要な点（更新）
- 複数POが1枚の請求書に混在する頻度は20%以下（当面はVI分割運用で吸収）
- PO番号はほぼ記載されないため、PO番号突合は前提にしない
- 税計算は税率別（変更の可能性あり）

### 推奨（暫定）
- まずは現行のまま（VI→PO は 0..1）で運用し、複数POが混在する請求書は「PO単位に VI を分割して登録」する
  - vendorInvoiceNo（請求書番号）は同一でも良い（同一番号の VI が複数件になり得る）
  - 追加の参照（他PO/案件の補足）は注釈（メモ/内部参照/外部URL）で補完する
  - 実務上は「同一請求書を分割登録」する運用であり、二重計上にならないよう合計金額の整合を必須にする
- 多対1が必須になった場合は、`VendorInvoice.purchaseOrderId` を中間テーブル（VI↔PO）へ移行し、既存のリンク変更/解除・監査ログ・履歴表示と整合させる
  - 最低限の不変条件として「同一 vendorId、原則同一 projectId」を満たす PO のみをリンク可能にする案が現実的
  - 申請時に金額分割とプロジェクト紐付けを行う運用を前提に、分割時は税率別の按分と端数調整をシステムで実施する
    - 端数調整が不可能な場合は理由付きで人にエスカレーションする

## 関連
- `docs/requirements/estimate-invoice-po-ui.md`
- `docs/requirements/domain-api-draft.md`
