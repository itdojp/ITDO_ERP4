# 経費精算の精算書/支払フロー（たたき台）

## 背景
旧システムでは「申請→承認→精算（支払）」の二段階運用があり、申請後の精算処理が重要な業務フローでした。ERP4 では申請/承認はあるものの、精算書（支払）単位や支払状態が未整理です。

## 現状（ERP4）
- Expense は明細単位で `draft/pending_*/approved/rejected` を持つ
- 申請承認フローは approval_rules に準拠
- 精算書/支払の状態・履歴が未実装

## 差分/課題
- 申請承認後の「精算（支払）」操作の所在がない
- 支払方法/税率/支払先など、実務に必要な属性が不足
- 複数明細を束ねる単位（精算書/バンドル）の要否が未決定

## MVP方針（案）
- 明細単位の精算で開始する（精算書は後続検討）
- 旧システムの「Submitter=支払対象」を踏襲し、支払先は原則 `userId` とする
- 外部支払先は既存の支払先名（外部会社名）で保持し、支払対象とは分離する

## 方針案（拡張）
### A. 明細単位の精算（MVP）
- Expense に `settlementStatus` / `paidAt` / `paidBy` を追加
- 精算操作は単票ごとに実施
- 実装負荷は低いが、件数が多い場合の運用負荷が残る

### B. 精算書（バンドル）単位
- ExpenseSettlement（精算書）を新設し、複数Expenseを紐付け
- 精算書で支払方法/支払日/担当を管理
- 実務運用に近いが設計/実装コストが増える

## 追加で整理すべき論点（未確定）
### 属性候補（MVP案）
- 支払先（支払対象）: `userId` を基本とする（従業員）
- 支払方法: 振込/現金/法人カード/立替相殺
- 税率: 0/8/10%（明細単位）
- 支払日: `paidAt` を保持（締め処理は後続）
- 証憑: `receiptUrl` を維持（命名規則は運用で定義）
- 備考: `notes`（必要に応じて追加）

### 状態遷移（案）
- 明細単位の場合:
  - draft → pending_qa → pending_exec → approved → settled/paid
  - 差戻し/却下は現行フローに準拠
- 精算書単位の場合:
  - expense: draft → pending → approved → linked
  - expense_settlement: draft → pending_payment → paid

### UI導線（案）
- 明細単位: 一覧に「精算済み」操作を追加（admin/mgmt）
- 精算書単位: 「精算書作成」→ 明細選択 → 承認/支払
- 検索/集計: 支払日/支払方法/担当/案件で絞り込み

### 監査/通知（案）
- 支払確定は監査ログに記録（誰が/いつ/金額）
- 支払完了通知: 申請者へアプリ内（メールは運用次第）

## TODO
- [ ] 属性要件の確定（支払方法/税率/備考 等）
- [ ] 明細単位精算（MVP）の状態遷移と権限を確定
- [ ] UI導線（精算操作、検索、証憑の扱い）の整理
- [ ] 精算書（バンドル）への拡張要否を判断

## 関連
- `docs/requirements/domain-api-draft.md`
- `docs/requirements/approval-alerts.md`
- `docs/requirements/reassignment-policy.md`
